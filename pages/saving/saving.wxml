<!--pages/saving/saving.wxml-->
<view class="energy-container">
  <!-- 背景装饰 -->
  <view class="energy-bg-decoration">
    <view class="energy-bg-circle" style="width: 200rpx; height: 200rpx; top: 10%; left: -50rpx; animation-delay: 0s;"></view>
    <view class="energy-bg-circle" style="width: 150rpx; height: 150rpx; top: 30%; right: -30rpx; animation-delay: 2s;"></view>
    <view class="energy-bg-circle" style="width: 100rpx; height: 100rpx; top: 60%; left: 20%; animation-delay: 4s;"></view>
    <view class="energy-bg-circle" style="width: 120rpx; height: 120rpx; bottom: 20%; right: 10%; animation-delay: 6s;"></view>
  </view>

  <!-- 页面标题 -->
  <view class="energy-glass-card energy-p-32 energy-mb-24">
    <view class="energy-flex energy-flex-between energy-mb-16">
      <text class="energy-title-large">节能方案</text>
      <view class="energy-flex">
        <view class="energy-icon energy-mr-16" bindtap="onRefresh">
          <text class="energy-icon-text {{refreshing ? 'rotating' : ''}}">🔄</text>
        </view>
      </view>
    </view>
    <view class="energy-text-tertiary">智能分析，个性化节能建议</view>
  </view>

  <!-- 节能概览 -->
  <view class="energy-glass-card energy-p-24 energy-mb-24">
    <view class="energy-title-small energy-mb-16">节能潜力概览</view>
    <view class="saving-overview-grid">
      <view class="saving-overview-item">
        <view class="overview-icon energy">⚡</view>
        <view class="overview-content">
          <text class="overview-value">{{overview.totalSavingPotential}}</text>
          <text class="overview-unit">kWh</text>
          <text class="overview-label">日节能潜力</text>
        </view>
      </view>
      <view class="saving-overview-item">
        <view class="overview-icon cost">💰</view>
        <view class="overview-content">
          <text class="overview-value">{{overview.costSavingPotential}}</text>
          <text class="overview-unit">元</text>
          <text class="overview-label">日节约潜力</text>
        </view>
      </view>
      <view class="saving-overview-item">
        <view class="overview-icon carbon">🌱</view>
        <view class="overview-content">
          <text class="overview-value">{{overview.carbonReductionPotential}}</text>
          <text class="overview-unit">kg</text>
          <text class="overview-label">日减碳潜力</text>
        </view>
      </view>
    </view>
  </view>

  <!-- 标签页导航 -->
  <view class="saving-tabs energy-mb-24">
    <view class="tab-item {{activeTab === 'plans' ? 'active' : ''}}" bindtap="onTabChange" data-tab="plans">
      <text class="tab-icon">📋</text>
      <text class="tab-text">节能方案</text>
    </view>
    <view class="tab-item {{activeTab === 'tips' ? 'active' : ''}}" bindtap="onTabChange" data-tab="tips">
      <text class="tab-icon">💡</text>
      <text class="tab-text">节能贴士</text>
    </view>
    <view class="tab-item {{activeTab === 'achievements' ? 'active' : ''}}" bindtap="onTabChange" data-tab="achievements">
      <text class="tab-icon">🏆</text>
      <text class="tab-text">节能成果</text>
    </view>
    <view class="tab-item {{activeTab === 'goals' ? 'active' : ''}}" bindtap="onTabChange" data-tab="goals">
      <text class="tab-icon">🎯</text>
      <text class="tab-text">节能目标</text>
    </view>
    <view class="tab-item {{activeTab === 'knowledge' ? 'active' : ''}}" bindtap="onTabChange" data-tab="knowledge">
      <text class="tab-icon">📚</text>
      <text class="tab-text">知识库</text>
    </view>
  </view>

  <!-- 节能方案标签页 -->
  <view wx:if="{{activeTab === 'plans'}}" class="tab-content">
    <!-- 筛选器 -->
    <view class="energy-glass-card energy-p-20 energy-mb-16">
      <view class="filter-section">
        <text class="filter-label">分类筛选：</text>
        <view class="filter-tags">
          <text class="filter-tag {{filters.planCategory === 'all' ? 'active' : ''}}" bindtap="onPlanFilter" data-type="planCategory" data-value="all">全部</text>
          <text class="filter-tag {{filters.planCategory === 'temperature' ? 'active' : ''}}" bindtap="onPlanFilter" data-type="planCategory" data-value="temperature">温控</text>
          <text class="filter-tag {{filters.planCategory === 'lighting' ? 'active' : ''}}" bindtap="onPlanFilter" data-type="planCategory" data-value="lighting">照明</text>
          <text class="filter-tag {{filters.planCategory === 'equipment' ? 'active' : ''}}" bindtap="onPlanFilter" data-type="planCategory" data-value="equipment">设备</text>
          <text class="filter-tag {{filters.planCategory === 'monitoring' ? 'active' : ''}}" bindtap="onPlanFilter" data-type="planCategory" data-value="monitoring">监控</text>
        </view>
      </view>
      <view class="filter-section">
        <text class="filter-label">优先级：</text>
        <view class="filter-tags">
          <text class="filter-tag {{filters.planPriority === 'all' ? 'active' : ''}}" bindtap="onPlanFilter" data-type="planPriority" data-value="all">全部</text>
          <text class="filter-tag {{filters.planPriority === 'high' ? 'active' : ''}}" bindtap="onPlanFilter" data-type="planPriority" data-value="high">高</text>
          <text class="filter-tag {{filters.planPriority === 'medium' ? 'active' : ''}}" bindtap="onPlanFilter" data-type="planPriority" data-value="medium">中</text>
          <text class="filter-tag {{filters.planPriority === 'low' ? 'active' : ''}}" bindtap="onPlanFilter" data-type="planPriority" data-value="low">低</text>
        </view>
      </view>
    </view>

    <!-- 方案列表 -->
    <view class="saving-plans-list">
      <view wx:for="{{savingPlans}}" wx:key="id" class="energy-glass-card energy-p-24 energy-mb-16 saving-plan-item">
        <view class="plan-header">
          <view class="plan-title-section">
            <text class="plan-title">{{item.title}}</text>
            <view class="plan-badges">
              <text class="priority-badge priority-{{item.priority}}">{{item.priority === 'high' ? '高优先级' : item.priority === 'medium' ? '中优先级' : '低优先级'}}</text>
              <text class="status-badge status-{{item.status}}">
                {{item.status === 'recommended' ? '推荐' : item.status === 'in_progress' ? '进行中' : item.status === 'planned' ? '计划中' : '评估中'}}
              </text>
            </view>
          </view>
          <view class="plan-actions">
            <text class="action-btn" bindtap="togglePlanDetail" data-plan-id="{{item.id}}">
              {{expandedItems.plans[item.id] ? '收起' : '详情'}}
            </text>
          </view>
        </view>

        <view class="plan-description energy-mb-16">
          <text class="energy-text-secondary">{{item.description}}</text>
        </view>

        <view class="plan-savings energy-mb-16">
          <view class="saving-item">
            <text class="saving-label">预计节能</text>
            <text class="saving-value">{{item.estimatedSaving.energy}} kWh</text>
          </view>
          <view class="saving-item">
            <text class="saving-label">预计节约</text>
            <text class="saving-value">{{item.estimatedSaving.cost}} 元</text>
          </view>
          <view class="saving-item">
            <text class="saving-label">减少碳排放</text>
            <text class="saving-value">{{item.estimatedSaving.carbon}} kg</text>
          </view>
        </view>

        <!-- 展开的详细信息 -->
        <view wx:if="{{expandedItems.plans[item.id]}}" class="plan-details">
          <view class="detail-section">
            <text class="detail-title">实施信息</text>
            <view class="detail-grid">
              <view class="detail-item">
                <text class="detail-label">难度</text>
                <text class="detail-value">{{item.implementation.difficulty}}</text>
              </view>
              <view class="detail-item">
                <text class="detail-label">时间</text>
                <text class="detail-value">{{item.implementation.timeRequired}}</text>
              </view>
              <view class="detail-item">
                <text class="detail-label">投资</text>
                <text class="detail-value">{{item.implementation.investment}}</text>
              </view>
              <view class="detail-item">
                <text class="detail-label">回报周期</text>
                <text class="detail-value">{{item.implementation.roi}}</text>
              </view>
            </view>
          </view>

          <view class="detail-section">
            <text class="detail-title">实施步骤</text>
            <view class="action-list">
              <view wx:for="{{item.actions}}" wx:for-item="action" wx:key="*this" class="action-item">
                <text class="action-number">{{index + 1}}</text>
                <text class="action-text">{{action}}</text>
              </view>
            </view>
          </view>
        </view>

        <view class="plan-footer">
          <view class="plan-buttons">
            <text class="btn-secondary" bindtap="viewPlanDetail" data-plan-id="{{item.id}}">查看详情</text>
            <text class="btn-primary" bindtap="executePlan" data-plan-id="{{item.id}}">执行方案</text>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- 节能贴士标签页 -->
  <view wx:if="{{activeTab === 'tips'}}" class="tab-content">
    <!-- 分类筛选 -->
    <view class="energy-glass-card energy-p-20 energy-mb-16">
      <view class="filter-section">
        <text class="filter-label">分类筛选：</text>
        <view class="filter-tags">
          <text class="filter-tag {{filters.tipCategory === 'all' ? 'active' : ''}}" bindtap="onPlanFilter" data-type="tipCategory" data-value="all">全部</text>
          <text class="filter-tag {{filters.tipCategory === 'daily' ? 'active' : ''}}" bindtap="onPlanFilter" data-type="tipCategory" data-value="daily">日常</text>
          <text class="filter-tag {{filters.tipCategory === 'lighting' ? 'active' : ''}}" bindtap="onPlanFilter" data-type="tipCategory" data-value="lighting">照明</text>
          <text class="filter-tag {{filters.tipCategory === 'equipment' ? 'active' : ''}}" bindtap="onPlanFilter" data-type="tipCategory" data-value="equipment">设备</text>
          <text class="filter-tag {{filters.tipCategory === 'water' ? 'active' : ''}}" bindtap="onPlanFilter" data-type="tipCategory" data-value="water">用水</text>
        </view>
      </view>
    </view>

    <!-- 贴士列表 -->
    <view class="saving-tips-list">
      <view wx:for="{{savingTips}}" wx:key="id" class="energy-glass-card energy-p-24 energy-mb-16 saving-tip-item">
        <view class="tip-header">
          <text class="tip-icon">{{item.icon}}</text>
          <view class="tip-info">
            <text class="tip-title">{{item.title}}</text>
            <view class="tip-badges">
              <text class="difficulty-badge difficulty-{{item.difficulty}}">{{item.difficulty === 'easy' ? '简单' : '中等'}}</text>
              <text class="potential-badge potential-{{item.savingPotential}}">{{item.savingPotential === 'high' ? '高效果' : '中效果'}}</text>
            </view>
          </view>
          <view class="tip-actions">
            <text class="action-btn" bindtap="shareTip" data-tip-id="{{item.id}}">分享</text>
          </view>
        </view>
        <view class="tip-content">
          <text class="energy-text-secondary">{{item.content}}</text>
        </view>
      </view>
    </view>
  </view>

  <!-- 节能成果标签页 -->
  <view wx:if="{{activeTab === 'achievements'}}" class="tab-content">
    <!-- 成果概览 -->
    <view class="energy-glass-card energy-p-24 energy-mb-16">
      <text class="energy-title-small energy-mb-16">累计成果</text>
      <view class="achievement-summary">
        <view class="achievement-item" bindtap="viewAchievementDetail" data-type="energy">
          <view class="achievement-icon energy">⚡</view>
          <view class="achievement-content">
            <text class="achievement-value">{{achievements.summary.totalEnergySaved}}</text>
            <text class="achievement-unit">kWh</text>
            <text class="achievement-label">累计节能</text>
          </view>
        </view>
        <view class="achievement-item" bindtap="viewAchievementDetail" data-type="cost">
          <view class="achievement-icon cost">💰</view>
          <view class="achievement-content">
            <text class="achievement-value">{{achievements.summary.totalCostSaved}}</text>
            <text class="achievement-unit">元</text>
            <text class="achievement-label">累计节约</text>
          </view>
        </view>
        <view class="achievement-item" bindtap="viewAchievementDetail" data-type="carbon">
          <view class="achievement-icon carbon">🌱</view>
          <view class="achievement-content">
            <text class="achievement-value">{{achievements.summary.totalCarbonReduced}}</text>
            <text class="achievement-unit">kg</text>
            <text class="achievement-label">累计减碳</text>
          </view>
        </view>
      </view>
    </view>

    <!-- 分类成果 -->
    <view class="energy-glass-card energy-p-24 energy-mb-16">
      <text class="energy-title-small energy-mb-16">分类成果</text>
      <view class="category-achievements">
        <view wx:for="{{achievements.categories}}" wx:key="category" class="category-item">
          <view class="category-header">
            <text class="category-name">{{item.name}}</text>
            <text class="category-percentage">{{item.percentage}}%</text>
          </view>
          <view class="category-progress">
            <view class="progress-bar">
              <view class="progress-fill" style="width: {{item.percentage}}%"></view>
            </view>
            <text class="category-value">{{item.energySaved}} kWh</text>
          </view>
        </view>
      </view>
    </view>

    <!-- 成就里程碑 -->
    <view class="energy-glass-card energy-p-24 energy-mb-16">
      <text class="energy-title-small energy-mb-16">成就里程碑</text>
      <view class="milestones-list">
        <view wx:for="{{achievements.milestones}}" wx:key="id" class="milestone-item">
          <view class="milestone-icon">🏆</view>
          <view class="milestone-content">
            <text class="milestone-title">{{item.title}}</text>
            <text class="milestone-description">{{item.description}}</text>
            <text class="milestone-date">{{item.achievedDate}}</text>
          </view>
          <view class="milestone-reward">
            <text class="reward-badge">{{item.reward}}</text>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- 节能目标标签页 -->
  <view wx:if="{{activeTab === 'goals'}}" class="tab-content">
    <!-- 当前目标 -->
    <view class="energy-glass-card energy-p-24 energy-mb-16">
      <view class="goal-header">
        <text class="energy-title-small">{{goals.current.title}}</text>
        <text class="goal-status status-{{goals.current.status}}">进行中</text>
      </view>
      
      <view class="goal-progress energy-mb-16">
        <view class="progress-item">
          <text class="progress-label">节能率进度</text>
          <view class="progress-bar-container">
            <view class="progress-bar">
              <view class="progress-fill" style="width: {{(goals.current.currentSavingRate / goals.current.targetSavingRate) * 100}}%"></view>
            </view>
            <text class="progress-text">{{goals.current.currentSavingRate}}% / {{goals.current.targetSavingRate}}%</text>
          </view>
        </view>
        
        <view class="progress-item">
          <text class="progress-label">节能量进度</text>
          <view class="progress-bar-container">
            <view class="progress-bar">
              <view class="progress-fill" style="width: {{(goals.current.currentEnergySaving / goals.current.targetEnergySaving) * 100}}%"></view>
            </view>
            <text class="progress-text">{{goals.current.currentEnergySaving}} / {{goals.current.targetEnergySaving}} kWh</text>
          </view>
        </view>
      </view>

      <view class="goal-actions">
        <text class="btn-primary" bindtap="setSavingGoal">调整目标</text>
      </view>
    </view>

    <!-- 目标建议 -->
    <view class="energy-glass-card energy-p-24 energy-mb-16">
      <text class="energy-title-small energy-mb-16">目标建议</text>
      <view class="suggestions-list">
        <view wx:for="{{goals.suggestions}}" wx:key="type" class="suggestion-item">
          <text class="suggestion-title">{{item.title}}</text>
          <text class="suggestion-description">{{item.description}}</text>
        </view>
      </view>
    </view>
  </view>

  <!-- 知识库标签页 -->
  <view wx:if="{{activeTab === 'knowledge'}}" class="tab-content">
    <!-- 分类筛选 -->
    <view class="energy-glass-card energy-p-20 energy-mb-16">
      <view class="filter-section">
        <text class="filter-label">分类筛选：</text>
        <view class="filter-tags">
          <text class="filter-tag {{filters.knowledgeCategory === 'all' ? 'active' : ''}}" bindtap="onPlanFilter" data-type="knowledgeCategory" data-value="all">全部</text>
          <text class="filter-tag {{filters.knowledgeCategory === 'basic' ? 'active' : ''}}" bindtap="onPlanFilter" data-type="knowledgeCategory" data-value="basic">基础</text>
          <text class="filter-tag {{filters.knowledgeCategory === 'technology' ? 'active' : ''}}" bindtap="onPlanFilter" data-type="knowledgeCategory" data-value="technology">技术</text>
          <text class="filter-tag {{filters.knowledgeCategory === 'practice' ? 'active' : ''}}" bindtap="onPlanFilter" data-type="knowledgeCategory" data-value="practice">实践</text>
          <text class="filter-tag {{filters.knowledgeCategory === 'policy' ? 'active' : ''}}" bindtap="onPlanFilter" data-type="knowledgeCategory" data-value="policy">政策</text>
          <text class="filter-tag {{filters.knowledgeCategory === 'case' ? 'active' : ''}}" bindtap="onPlanFilter" data-type="knowledgeCategory" data-value="case">案例</text>
        </view>
      </view>
    </view>

    <!-- 知识列表 -->
    <view class="knowledge-list">
      <view wx:for="{{knowledgeBase}}" wx:key="id" class="energy-glass-card energy-p-24 energy-mb-16 knowledge-item">
        <view class="knowledge-header" bindtap="toggleKnowledgeDetail" data-knowledge-id="{{item.id}}">
          <view class="knowledge-info">
            <text class="knowledge-title">{{item.title}}</text>
            <text class="knowledge-summary">{{item.summary}}</text>
            <view class="knowledge-meta">
              <text class="read-time">📖 {{item.readTime}}分钟</text>
              <text class="difficulty difficulty-{{item.difficulty}}">{{item.difficulty === 'beginner' ? '入门' : item.difficulty === 'intermediate' ? '中级' : '高级'}}</text>
            </view>
          </view>
          <view class="knowledge-toggle">
            <text class="toggle-icon">{{expandedItems.knowledge[item.id] ? '▼' : '▶'}}</text>
          </view>
        </view>

        <view wx:if="{{expandedItems.knowledge[item.id]}}" class="knowledge-content">
          <text class="knowledge-text">{{item.content}}</text>
          <view class="knowledge-tags">
            <text wx:for="{{item.tags}}" wx:for-item="tag" wx:key="*this" class="knowledge-tag">{{tag}}</text>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- 加载状态 -->
  <view wx:if="{{loading}}" class="energy-glass-card energy-p-32 energy-flex-center">
    <text class="energy-text-secondary">加载中...</text>
  </view>

  <!-- 快捷操作 -->
  <view class="quick-actions energy-mb-32">
    <view class="energy-glass-card energy-p-24">
      <text class="energy-title-small energy-mb-16">快捷操作</text>
      <view class="action-buttons">
        <view class="action-button" bindtap="navigateToDevices">
          <text class="action-icon">🔌</text>
          <text class="action-text">设备管理</text>
        </view>
        <view class="action-button" bindtap="navigateToData">
          <text class="action-icon">📊</text>
          <text class="action-text">数据分析</text>
        </view>
      </view>
    </view>
  </view>

  <custom-footer></custom-footer>
</view>