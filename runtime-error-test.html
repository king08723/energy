<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¿è¡Œæ—¶é”™è¯¯ä¿®å¤éªŒè¯æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(248, 250, 252, 0.8);
            border-radius: 10px;
            border-left: 4px solid #3b82f6;
        }

        .test-button {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            margin: 5px;
            font-weight: 600;
        }

        .test-button.danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }

        .test-button.success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }

        .log-container {
            background: #1f2937;
            color: #f9fafb;
            padding: 20px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 15px;
        }

        .log-entry {
            margin-bottom: 8px;
            padding: 5px;
            border-radius: 4px;
        }

        .log-entry.error {
            background: rgba(239, 68, 68, 0.2);
            border-left: 3px solid #ef4444;
        }

        .log-entry.success {
            background: rgba(16, 185, 129, 0.2);
            border-left: 3px solid #10b981;
        }

        .log-entry.warning {
            background: rgba(245, 158, 11, 0.2);
            border-left: 3px solid #f59e0b;
        }

        .log-entry.info {
            background: rgba(59, 130, 246, 0.2);
            border-left: 3px solid #3b82f6;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-indicator.pass {
            background: #10b981;
        }

        .status-indicator.fail {
            background: #ef4444;
        }

        .status-indicator.pending {
            background: #f59e0b;
        }

        .test-results {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .test-result-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }

        .test-result-card h4 {
            margin: 0 0 10px 0;
            color: #1f2937;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>ğŸ”§ è¿è¡Œæ—¶é”™è¯¯ä¿®å¤éªŒè¯æµ‹è¯•</h1>
        <p>éªŒè¯ä¿®å¤åçš„è®¾å¤‡ç®¡ç†é¡µé¢è¿è¡Œæ—¶é”™è¯¯å’Œæ€§èƒ½ä¼˜åŒ–</p>

        <!-- é”™è¯¯ä¿®å¤æµ‹è¯• -->
        <div class="test-section">
            <h3>ğŸš¨ å…³é”®é”™è¯¯ä¿®å¤æµ‹è¯•</h3>
            <div>
                <button class="test-button" onclick="testBuildDeviceUpdate()">æµ‹è¯• buildDeviceUpdate é”™è¯¯ä¿®å¤</button>
                <button class="test-button" onclick="testUpdateDeviceStatus()">æµ‹è¯• updateDeviceStatus é”™è¯¯å¤„ç†</button>
                <button class="test-button" onclick="testRealTimeMessage()">æµ‹è¯•å®æ—¶æ¶ˆæ¯å¤„ç†</button>
                <button class="test-button" onclick="testDataStructures()">æµ‹è¯•æ•°æ®ç»“æ„åˆå§‹åŒ–</button>
            </div>
        </div>

        <!-- è¾¹ç•Œæ¡ä»¶æµ‹è¯• -->
        <div class="test-section">
            <h3>ğŸ¯ è¾¹ç•Œæ¡ä»¶æµ‹è¯•</h3>
            <div>
                <button class="test-button" onclick="testNullParameters()">æµ‹è¯•ç©ºå‚æ•°å¤„ç†</button>
                <button class="test-button" onclick="testUndefinedDevices()">æµ‹è¯•æœªå®šä¹‰è®¾å¤‡å¤„ç†</button>
                <button class="test-button" onclick="testInvalidData()">æµ‹è¯•æ— æ•ˆæ•°æ®å¤„ç†</button>
                <button class="test-button danger" onclick="testErrorScenarios()">æµ‹è¯•é”™è¯¯åœºæ™¯</button>
            </div>
        </div>

        <!-- æ€§èƒ½å›å½’æµ‹è¯• -->
        <div class="test-section">
            <h3>âš¡ æ€§èƒ½å›å½’æµ‹è¯•</h3>
            <div>
                <button class="test-button success" onclick="testPerformanceRegression()">è¿è¡Œæ€§èƒ½å›å½’æµ‹è¯•</button>
                <button class="test-button" onclick="testMemoryLeaks()">æµ‹è¯•å†…å­˜æ³„æ¼ä¿®å¤</button>
                <button class="test-button" onclick="testCacheEfficiency()">æµ‹è¯•ç¼“å­˜æ•ˆç‡</button>
            </div>
        </div>

        <!-- æµ‹è¯•ç»“æœ -->
        <div class="test-section">
            <h3>ğŸ“Š æµ‹è¯•ç»“æœ</h3>
            <div class="test-results" id="testResults"></div>
        </div>

        <!-- æ—¥å¿—è¾“å‡º -->
        <div class="log-container" id="logContainer"></div>
    </div>

    <script>
        // æ¨¡æ‹Ÿä¿®å¤åçš„è®¾å¤‡ç®¡ç†é¡µé¢å¯¹è±¡
        const devicePage = {
            data: {
                debugMode: true,
                allDevices: [],
                filteredDevices: [],
                devices: []
            },

            // æ¨¡æ‹Ÿåˆå§‹åŒ–åçš„å¤æ‚å¯¹è±¡
            performanceMonitor: null,
            activeTimers: null,
            dataCache: null,

            // åˆå§‹åŒ–æ€§èƒ½ç›‘æ§ï¼ˆä¿®å¤åçš„ç‰ˆæœ¬ï¼‰
            initPerformanceMonitor() {
                this.performanceMonitor = {
                    setDataCount: 0,
                    searchOperations: 0,
                    filterOperations: 0,
                    realTimeUpdates: 0,
                    memoryUsage: 0,
                    lastCleanup: Date.now(),
                    startTime: Date.now()
                };

                this.activeTimers = new Set();

                this.dataCache = {
                    lastFilterResult: null,
                    lastFilterParams: null,
                    deviceLookup: new Map()
                };
            },

            // ä¿®å¤åçš„ buildDeviceUpdate å‡½æ•°
            buildDeviceUpdate(currentDevice, statusData) {
                const updates = {};

                // é˜²å¾¡æ€§ç¼–ç¨‹ï¼šæ£€æŸ¥å‚æ•°æœ‰æ•ˆæ€§
                if (!currentDevice || typeof currentDevice !== 'object') {
                    if (this.data.debugMode) {
                        console.warn('buildDeviceUpdate: currentDevice is invalid', currentDevice);
                    }
                    return updates;
                }

                if (!statusData || typeof statusData !== 'object') {
                    if (this.data.debugMode) {
                        console.warn('buildDeviceUpdate: statusData is invalid', statusData);
                    }
                    return updates;
                }

                // å®‰å…¨åœ°æ¯”è¾ƒå’Œæ›´æ–°å­—æ®µ
                try {
                    if (statusData.status !== undefined && currentDevice.status !== statusData.status) {
                        updates.status = statusData.status;
                        updates.statusText = statusData.status === 'online' ? 'åœ¨çº¿' : 'ç¦»çº¿';
                    }
                    if (statusData.power !== undefined && currentDevice.power !== statusData.power) {
                        updates.power = statusData.power;
                    }
                    if (statusData.energy !== undefined && currentDevice.energy !== statusData.energy) {
                        updates.energy = statusData.energy;
                    }
                    if (statusData.timestamp !== undefined && currentDevice.lastUpdate !== statusData.timestamp) {
                        updates.lastUpdate = statusData.timestamp;
                    }
                } catch (error) {
                    console.error('buildDeviceUpdate: Error processing updates', error, {
                        currentDevice,
                        statusData
                    });
                }

                return updates;
            },

            // ä¿®å¤åçš„ updateDeviceStatus å‡½æ•°ï¼ˆç®€åŒ–ç‰ˆï¼‰
            updateDeviceStatus(deviceId, statusData) {
                // å‚æ•°éªŒè¯
                if (!deviceId || !statusData) {
                    if (this.data.debugMode) {
                        console.warn('updateDeviceStatus: Invalid parameters', { deviceId, statusData });
                    }
                    return;
                }

                try {
                    if (this.performanceMonitor) {
                        this.performanceMonitor.realTimeUpdates++;
                    }

                    // ç¡®ä¿æ•°æ®ç»“æ„å­˜åœ¨
                    const { allDevices = [], filteredDevices = [], devices = [] } = this.data;

                    // æ¨¡æ‹Ÿè®¾å¤‡æŸ¥æ‰¾å’Œæ›´æ–°
                    const device = allDevices.find(d => d && d.id === deviceId);
                    if (device) {
                        const updates = this.buildDeviceUpdate(device, statusData);
                        return updates;
                    }

                    return null;
                } catch (error) {
                    console.error('updateDeviceStatus: Critical error', error, {
                        deviceId,
                        statusData
                    });
                    return null;
                }
            },

            // ä¿®å¤åçš„ handleRealTimeMessage å‡½æ•°
            handleRealTimeMessage(message) {
                // å‚æ•°éªŒè¯
                if (!message || typeof message !== 'object') {
                    if (this.data.debugMode) {
                        console.warn('handleRealTimeMessage: Invalid message', message);
                    }
                    return;
                }

                try {
                    const { type, deviceId, data } = message;

                    // éªŒè¯å¿…è¦å­—æ®µ
                    if (!type || !deviceId) {
                        if (this.data.debugMode) {
                            console.warn('handleRealTimeMessage: Missing required fields', { type, deviceId });
                        }
                        return;
                    }

                    switch (type) {
                        case 'device_update':
                            if (data && typeof data === 'object') {
                                return this.updateDeviceStatus(deviceId, data);
                            } else {
                                if (this.data.debugMode) {
                                    console.warn('handleRealTimeMessage: Invalid device_update data', { deviceId, data });
                                }
                            }
                            break;
                        default:
                            if (this.data.debugMode) {
                                console.warn('handleRealTimeMessage: Unknown message type', { type, deviceId });
                            }
                            break;
                    }
                } catch (error) {
                    console.error('handleRealTimeMessage: Critical error', error, { message });
                }
            }
        };

        // æµ‹è¯•ç»“æœå­˜å‚¨
        const testResults = [];

        // æ—¥å¿—å‡½æ•°
        function logMessage(message, type = 'info') {
            const logContainer = document.getElementById('logContainer');
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${type}`;
            logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        // æ·»åŠ æµ‹è¯•ç»“æœ
        function addTestResult(testName, passed, details = '') {
            testResults.push({ testName, passed, details });
            updateTestResults();
        }

        // æ›´æ–°æµ‹è¯•ç»“æœæ˜¾ç¤º
        function updateTestResults() {
            const resultsContainer = document.getElementById('testResults');
            resultsContainer.innerHTML = '';

            testResults.forEach(result => {
                const card = document.createElement('div');
                card.className = 'test-result-card';
                card.innerHTML = `
                    <h4>
                        <span class="status-indicator ${result.passed ? 'pass' : 'fail'}"></span>
                        ${result.testName}
                    </h4>
                    <p>${result.details}</p>
                `;
                resultsContainer.appendChild(card);
            });
        }

        // æµ‹è¯•å‡½æ•°
        function testBuildDeviceUpdate() {
            logMessage('å¼€å§‹æµ‹è¯• buildDeviceUpdate é”™è¯¯ä¿®å¤...', 'info');

            let passed = true;
            let details = '';

            try {
                // æµ‹è¯•1: æ­£å¸¸æƒ…å†µ
                const device = { id: 'test1', status: 'offline', power: 100 };
                const statusData = { status: 'online', power: 200 };
                const result1 = devicePage.buildDeviceUpdate(device, statusData);

                if (!result1 || typeof result1 !== 'object') {
                    passed = false;
                    details += 'æ­£å¸¸æƒ…å†µæµ‹è¯•å¤±è´¥; ';
                }

                // æµ‹è¯•2: currentDevice ä¸º null
                const result2 = devicePage.buildDeviceUpdate(null, statusData);
                if (Object.keys(result2).length !== 0) {
                    passed = false;
                    details += 'nullè®¾å¤‡æµ‹è¯•å¤±è´¥; ';
                }

                // æµ‹è¯•3: currentDevice ä¸º undefined
                const result3 = devicePage.buildDeviceUpdate(undefined, statusData);
                if (Object.keys(result3).length !== 0) {
                    passed = false;
                    details += 'undefinedè®¾å¤‡æµ‹è¯•å¤±è´¥; ';
                }

                // æµ‹è¯•4: statusData ä¸º null
                const result4 = devicePage.buildDeviceUpdate(device, null);
                if (Object.keys(result4).length !== 0) {
                    passed = false;
                    details += 'nullçŠ¶æ€æ•°æ®æµ‹è¯•å¤±è´¥; ';
                }

                details = passed ? 'æ‰€æœ‰æµ‹è¯•é€šè¿‡' : details;

            } catch (error) {
                passed = false;
                details = `æµ‹è¯•è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯: ${error.message}`;
                logMessage(`buildDeviceUpdate æµ‹è¯•é”™è¯¯: ${error.message}`, 'error');
            }

            addTestResult('buildDeviceUpdate é”™è¯¯ä¿®å¤', passed, details);
            logMessage(`buildDeviceUpdate æµ‹è¯•å®Œæˆ: ${passed ? 'é€šè¿‡' : 'å¤±è´¥'}`, passed ? 'success' : 'error');
        }

        function testUpdateDeviceStatus() {
            logMessage('å¼€å§‹æµ‹è¯• updateDeviceStatus é”™è¯¯å¤„ç†...', 'info');

            let passed = true;
            let details = '';

            try {
                // è®¾ç½®æµ‹è¯•æ•°æ®
                devicePage.data.allDevices = [
                    { id: 'device1', status: 'offline', power: 100 },
                    { id: 'device2', status: 'online', power: 200 }
                ];

                // æµ‹è¯•1: æ­£å¸¸æ›´æ–°
                const result1 = devicePage.updateDeviceStatus('device1', { status: 'online' });
                if (result1 === null) {
                    passed = false;
                    details += 'æ­£å¸¸æ›´æ–°æµ‹è¯•å¤±è´¥; ';
                }

                // æµ‹è¯•2: æ— æ•ˆè®¾å¤‡ID
                const result2 = devicePage.updateDeviceStatus(null, { status: 'online' });
                if (result2 !== undefined) {
                    passed = false;
                    details += 'æ— æ•ˆè®¾å¤‡IDæµ‹è¯•å¤±è´¥; ';
                }

                // æµ‹è¯•3: æ— æ•ˆçŠ¶æ€æ•°æ®
                const result3 = devicePage.updateDeviceStatus('device1', null);
                if (result3 !== undefined) {
                    passed = false;
                    details += 'æ— æ•ˆçŠ¶æ€æ•°æ®æµ‹è¯•å¤±è´¥; ';
                }

                // æµ‹è¯•4: ä¸å­˜åœ¨çš„è®¾å¤‡
                const result4 = devicePage.updateDeviceStatus('nonexistent', { status: 'online' });
                if (result4 !== null) {
                    passed = false;
                    details += 'ä¸å­˜åœ¨è®¾å¤‡æµ‹è¯•å¤±è´¥; ';
                }

                details = passed ? 'æ‰€æœ‰æµ‹è¯•é€šè¿‡' : details;

            } catch (error) {
                passed = false;
                details = `æµ‹è¯•è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯: ${error.message}`;
                logMessage(`updateDeviceStatus æµ‹è¯•é”™è¯¯: ${error.message}`, 'error');
            }

            addTestResult('updateDeviceStatus é”™è¯¯å¤„ç†', passed, details);
            logMessage(`updateDeviceStatus æµ‹è¯•å®Œæˆ: ${passed ? 'é€šè¿‡' : 'å¤±è´¥'}`, passed ? 'success' : 'error');
        }

        function testRealTimeMessage() {
            logMessage('å¼€å§‹æµ‹è¯•å®æ—¶æ¶ˆæ¯å¤„ç†...', 'info');

            let passed = true;
            let details = '';

            try {
                // è®¾ç½®æµ‹è¯•æ•°æ®
                devicePage.data.allDevices = [
                    { id: 'device1', status: 'offline', power: 100 }
                ];

                // æµ‹è¯•1: æ­£å¸¸æ¶ˆæ¯
                devicePage.handleRealTimeMessage({
                    type: 'device_update',
                    deviceId: 'device1',
                    data: { status: 'online' }
                });

                // æµ‹è¯•2: æ— æ•ˆæ¶ˆæ¯
                devicePage.handleRealTimeMessage(null);
                devicePage.handleRealTimeMessage(undefined);
                devicePage.handleRealTimeMessage('invalid');

                // æµ‹è¯•3: ç¼ºå°‘å­—æ®µ
                devicePage.handleRealTimeMessage({
                    type: 'device_update'
                    // ç¼ºå°‘ deviceId
                });

                // æµ‹è¯•4: æ— æ•ˆæ•°æ®
                devicePage.handleRealTimeMessage({
                    type: 'device_update',
                    deviceId: 'device1',
                    data: null
                });

                // æµ‹è¯•5: æœªçŸ¥æ¶ˆæ¯ç±»å‹
                devicePage.handleRealTimeMessage({
                    type: 'unknown_type',
                    deviceId: 'device1',
                    data: { status: 'online' }
                });

                details = 'æ‰€æœ‰è¾¹ç•Œæ¡ä»¶æµ‹è¯•é€šè¿‡';

            } catch (error) {
                passed = false;
                details = `æµ‹è¯•è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯: ${error.message}`;
                logMessage(`å®æ—¶æ¶ˆæ¯å¤„ç†æµ‹è¯•é”™è¯¯: ${error.message}`, 'error');
            }

            addTestResult('å®æ—¶æ¶ˆæ¯å¤„ç†', passed, details);
            logMessage(`å®æ—¶æ¶ˆæ¯å¤„ç†æµ‹è¯•å®Œæˆ: ${passed ? 'é€šè¿‡' : 'å¤±è´¥'}`, passed ? 'success' : 'error');
        }

        function testDataStructures() {
            logMessage('å¼€å§‹æµ‹è¯•æ•°æ®ç»“æ„åˆå§‹åŒ–...', 'info');

            let passed = true;
            let details = '';

            try {
                // é‡æ–°åˆå§‹åŒ–
                devicePage.performanceMonitor = null;
                devicePage.activeTimers = null;
                devicePage.dataCache = null;

                devicePage.initPerformanceMonitor();

                // éªŒè¯åˆå§‹åŒ–
                if (!devicePage.performanceMonitor || typeof devicePage.performanceMonitor !== 'object') {
                    passed = false;
                    details += 'performanceMonitoråˆå§‹åŒ–å¤±è´¥; ';
                }

                if (!devicePage.activeTimers || typeof devicePage.activeTimers.add !== 'function') {
                    passed = false;
                    details += 'activeTimersåˆå§‹åŒ–å¤±è´¥; ';
                }

                if (!devicePage.dataCache || typeof devicePage.dataCache !== 'object') {
                    passed = false;
                    details += 'dataCacheåˆå§‹åŒ–å¤±è´¥; ';
                }

                if (!devicePage.dataCache.deviceLookup || typeof devicePage.dataCache.deviceLookup.set !== 'function') {
                    passed = false;
                    details += 'deviceLookupåˆå§‹åŒ–å¤±è´¥; ';
                }

                details = passed ? 'æ‰€æœ‰æ•°æ®ç»“æ„æ­£ç¡®åˆå§‹åŒ–' : details;

            } catch (error) {
                passed = false;
                details = `æµ‹è¯•è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯: ${error.message}`;
                logMessage(`æ•°æ®ç»“æ„åˆå§‹åŒ–æµ‹è¯•é”™è¯¯: ${error.message}`, 'error');
            }

            addTestResult('æ•°æ®ç»“æ„åˆå§‹åŒ–', passed, details);
            logMessage(`æ•°æ®ç»“æ„åˆå§‹åŒ–æµ‹è¯•å®Œæˆ: ${passed ? 'é€šè¿‡' : 'å¤±è´¥'}`, passed ? 'success' : 'error');
        }

        function testNullParameters() {
            logMessage('å¼€å§‹æµ‹è¯•ç©ºå‚æ•°å¤„ç†...', 'info');

            let passed = true;
            let details = '';

            try {
                // æµ‹è¯•å„ç§null/undefinedå‚æ•°ç»„åˆ
                const testCases = [
                    [null, null],
                    [undefined, undefined],
                    ['', null],
                    [null, {}],
                    ['device1', null],
                    [null, { status: 'online' }]
                ];

                testCases.forEach((testCase, index) => {
                    try {
                        devicePage.updateDeviceStatus(testCase[0], testCase[1]);
                        devicePage.buildDeviceUpdate(testCase[0], testCase[1]);
                    } catch (error) {
                        passed = false;
                        details += `æµ‹è¯•ç”¨ä¾‹${index + 1}å¤±è´¥: ${error.message}; `;
                    }
                });

                details = passed ? 'æ‰€æœ‰ç©ºå‚æ•°æµ‹è¯•é€šè¿‡' : details;

            } catch (error) {
                passed = false;
                details = `æµ‹è¯•è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯: ${error.message}`;
                logMessage(`ç©ºå‚æ•°å¤„ç†æµ‹è¯•é”™è¯¯: ${error.message}`, 'error');
            }

            addTestResult('ç©ºå‚æ•°å¤„ç†', passed, details);
            logMessage(`ç©ºå‚æ•°å¤„ç†æµ‹è¯•å®Œæˆ: ${passed ? 'é€šè¿‡' : 'å¤±è´¥'}`, passed ? 'success' : 'error');
        }

        function testUndefinedDevices() {
            logMessage('å¼€å§‹æµ‹è¯•æœªå®šä¹‰è®¾å¤‡å¤„ç†...', 'info');

            let passed = true;
            let details = '';

            try {
                // æ¸…ç©ºè®¾å¤‡æ•°æ®
                devicePage.data.allDevices = [];
                devicePage.data.filteredDevices = [];
                devicePage.data.devices = [];

                // æµ‹è¯•åœ¨ç©ºè®¾å¤‡åˆ—è¡¨ä¸­æ›´æ–°è®¾å¤‡
                devicePage.updateDeviceStatus('nonexistent', { status: 'online' });

                // æµ‹è¯•åœ¨åŒ…å«nullå…ƒç´ çš„è®¾å¤‡åˆ—è¡¨ä¸­æ›´æ–°
                devicePage.data.allDevices = [null, undefined, { id: 'device1' }];
                devicePage.updateDeviceStatus('device1', { status: 'online' });

                details = 'æœªå®šä¹‰è®¾å¤‡å¤„ç†æµ‹è¯•é€šè¿‡';

            } catch (error) {
                passed = false;
                details = `æµ‹è¯•è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯: ${error.message}`;
                logMessage(`æœªå®šä¹‰è®¾å¤‡å¤„ç†æµ‹è¯•é”™è¯¯: ${error.message}`, 'error');
            }

            addTestResult('æœªå®šä¹‰è®¾å¤‡å¤„ç†', passed, details);
            logMessage(`æœªå®šä¹‰è®¾å¤‡å¤„ç†æµ‹è¯•å®Œæˆ: ${passed ? 'é€šè¿‡' : 'å¤±è´¥'}`, passed ? 'success' : 'error');
        }

        function testInvalidData() {
            logMessage('å¼€å§‹æµ‹è¯•æ— æ•ˆæ•°æ®å¤„ç†...', 'info');

            let passed = true;
            let details = '';

            try {
                // æµ‹è¯•å„ç§æ— æ•ˆæ•°æ®ç±»å‹
                const invalidData = [
                    'string',
                    123,
                    [],
                    true,
                    false,
                    function () { },
                    Symbol('test')
                ];

                invalidData.forEach((data, index) => {
                    try {
                        devicePage.buildDeviceUpdate(data, { status: 'online' });
                        devicePage.buildDeviceUpdate({ id: 'test' }, data);
                        devicePage.handleRealTimeMessage(data);
                    } catch (error) {
                        passed = false;
                        details += `æ— æ•ˆæ•°æ®ç±»å‹${index + 1}æµ‹è¯•å¤±è´¥: ${error.message}; `;
                    }
                });

                details = passed ? 'æ‰€æœ‰æ— æ•ˆæ•°æ®æµ‹è¯•é€šè¿‡' : details;

            } catch (error) {
                passed = false;
                details = `æµ‹è¯•è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯: ${error.message}`;
                logMessage(`æ— æ•ˆæ•°æ®å¤„ç†æµ‹è¯•é”™è¯¯: ${error.message}`, 'error');
            }

            addTestResult('æ— æ•ˆæ•°æ®å¤„ç†', passed, details);
            logMessage(`æ— æ•ˆæ•°æ®å¤„ç†æµ‹è¯•å®Œæˆ: ${passed ? 'é€šè¿‡' : 'å¤±è´¥'}`, passed ? 'success' : 'error');
        }

        function testErrorScenarios() {
            logMessage('å¼€å§‹æµ‹è¯•é”™è¯¯åœºæ™¯...', 'warning');

            let passed = true;
            let details = '';

            try {
                // æ¨¡æ‹Ÿå„ç§é”™è¯¯åœºæ™¯

                // 1. æ•°æ®ç»“æ„æœªåˆå§‹åŒ–
                const originalPerformanceMonitor = devicePage.performanceMonitor;
                const originalDataCache = devicePage.dataCache;

                devicePage.performanceMonitor = null;
                devicePage.dataCache = null;

                devicePage.updateDeviceStatus('device1', { status: 'online' });

                // æ¢å¤æ•°æ®ç»“æ„
                devicePage.performanceMonitor = originalPerformanceMonitor;
                devicePage.dataCache = originalDataCache;

                // 2. å¾ªç¯å¼•ç”¨å¯¹è±¡
                const circularObj = { status: 'online' };
                circularObj.self = circularObj;

                devicePage.buildDeviceUpdate({ id: 'test' }, circularObj);

                details = 'æ‰€æœ‰é”™è¯¯åœºæ™¯æµ‹è¯•é€šè¿‡';

            } catch (error) {
                passed = false;
                details = `æµ‹è¯•è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯: ${error.message}`;
                logMessage(`é”™è¯¯åœºæ™¯æµ‹è¯•é”™è¯¯: ${error.message}`, 'error');
            }

            addTestResult('é”™è¯¯åœºæ™¯å¤„ç†', passed, details);
            logMessage(`é”™è¯¯åœºæ™¯æµ‹è¯•å®Œæˆ: ${passed ? 'é€šè¿‡' : 'å¤±è´¥'}`, passed ? 'success' : 'error');
        }

        function testPerformanceRegression() {
            logMessage('å¼€å§‹æ€§èƒ½å›å½’æµ‹è¯•...', 'info');

            let passed = true;
            let details = '';

            try {
                const startTime = Date.now();

                // æ‰§è¡Œå¤§é‡æ“ä½œ
                for (let i = 0; i < 1000; i++) {
                    devicePage.buildDeviceUpdate(
                        { id: `device${i}`, status: 'offline' },
                        { status: 'online', power: Math.random() * 1000 }
                    );
                }

                const duration = Date.now() - startTime;

                if (duration > 1000) { // å¦‚æœè¶…è¿‡1ç§’è®¤ä¸ºæ€§èƒ½æœ‰é—®é¢˜
                    passed = false;
                    details = `æ€§èƒ½æµ‹è¯•è€—æ—¶è¿‡é•¿: ${duration}ms`;
                } else {
                    details = `æ€§èƒ½æµ‹è¯•é€šè¿‡ï¼Œè€—æ—¶: ${duration}ms`;
                }

            } catch (error) {
                passed = false;
                details = `æµ‹è¯•è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯: ${error.message}`;
                logMessage(`æ€§èƒ½å›å½’æµ‹è¯•é”™è¯¯: ${error.message}`, 'error');
            }

            addTestResult('æ€§èƒ½å›å½’æµ‹è¯•', passed, details);
            logMessage(`æ€§èƒ½å›å½’æµ‹è¯•å®Œæˆ: ${passed ? 'é€šè¿‡' : 'å¤±è´¥'}`, passed ? 'success' : 'error');
        }

        function testMemoryLeaks() {
            logMessage('å¼€å§‹å†…å­˜æ³„æ¼æµ‹è¯•...', 'info');

            let passed = true;
            let details = '';

            try {
                const initialMemory = performance.memory ? performance.memory.usedJSHeapSize : 0;

                // æ‰§è¡Œå¤§é‡æ“ä½œæ¨¡æ‹Ÿå†…å­˜ä½¿ç”¨
                for (let i = 0; i < 10000; i++) {
                    const device = { id: `device${i}`, status: 'offline', data: new Array(100).fill(i) };
                    const statusData = { status: 'online', power: Math.random() * 1000 };
                    devicePage.buildDeviceUpdate(device, statusData);
                }

                // å¼ºåˆ¶åƒåœ¾å›æ”¶ï¼ˆå¦‚æœæ”¯æŒï¼‰
                if (window.gc) {
                    window.gc();
                }

                const finalMemory = performance.memory ? performance.memory.usedJSHeapSize : 0;
                const memoryIncrease = finalMemory - initialMemory;

                if (memoryIncrease > 50 * 1024 * 1024) { // å¦‚æœå†…å­˜å¢é•¿è¶…è¿‡50MB
                    passed = false;
                    details = `å¯èƒ½å­˜åœ¨å†…å­˜æ³„æ¼ï¼Œå†…å­˜å¢é•¿: ${(memoryIncrease / 1024 / 1024).toFixed(2)}MB`;
                } else {
                    details = `å†…å­˜ä½¿ç”¨æ­£å¸¸ï¼Œå¢é•¿: ${(memoryIncrease / 1024 / 1024).toFixed(2)}MB`;
                }

            } catch (error) {
                passed = false;
                details = `æµ‹è¯•è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯: ${error.message}`;
                logMessage(`å†…å­˜æ³„æ¼æµ‹è¯•é”™è¯¯: ${error.message}`, 'error');
            }

            addTestResult('å†…å­˜æ³„æ¼æµ‹è¯•', passed, details);
            logMessage(`å†…å­˜æ³„æ¼æµ‹è¯•å®Œæˆ: ${passed ? 'é€šè¿‡' : 'å¤±è´¥'}`, passed ? 'success' : 'error');
        }

        function testCacheEfficiency() {
            logMessage('å¼€å§‹ç¼“å­˜æ•ˆç‡æµ‹è¯•...', 'info');

            let passed = true;
            let details = '';

            try {
                // æµ‹è¯•ç¼“å­˜åŠŸèƒ½
                const cache = devicePage.dataCache.deviceLookup;

                // æ·»åŠ ç¼“å­˜é¡¹
                cache.set('device1', { all: 0, filtered: 0, display: 0 });
                cache.set('device2', { all: 1, filtered: 1, display: 1 });

                // éªŒè¯ç¼“å­˜
                if (!cache.has('device1') || !cache.has('device2')) {
                    passed = false;
                    details += 'ç¼“å­˜å­˜å‚¨å¤±è´¥; ';
                }

                // éªŒè¯ç¼“å­˜æ£€ç´¢
                const cached1 = cache.get('device1');
                if (!cached1 || cached1.all !== 0) {
                    passed = false;
                    details += 'ç¼“å­˜æ£€ç´¢å¤±è´¥; ';
                }

                // æµ‹è¯•ç¼“å­˜æ¸…ç†
                cache.clear();
                if (cache.size !== 0) {
                    passed = false;
                    details += 'ç¼“å­˜æ¸…ç†å¤±è´¥; ';
                }

                details = passed ? 'ç¼“å­˜åŠŸèƒ½æ­£å¸¸' : details;

            } catch (error) {
                passed = false;
                details = `æµ‹è¯•è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯: ${error.message}`;
                logMessage(`ç¼“å­˜æ•ˆç‡æµ‹è¯•é”™è¯¯: ${error.message}`, 'error');
            }

            addTestResult('ç¼“å­˜æ•ˆç‡æµ‹è¯•', passed, details);
            logMessage(`ç¼“å­˜æ•ˆç‡æµ‹è¯•å®Œæˆ: ${passed ? 'é€šè¿‡' : 'å¤±è´¥'}`, passed ? 'success' : 'error');
        }

        // åˆå§‹åŒ–
        window.onload = function () {
            devicePage.initPerformanceMonitor();
            logMessage('è¿è¡Œæ—¶é”™è¯¯ä¿®å¤éªŒè¯æµ‹è¯•å·²åˆå§‹åŒ–', 'info');
        };
    </script>
</body>

</html>