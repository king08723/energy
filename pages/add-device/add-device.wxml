<!--pages/add-device/add-device.wxml-->
<view class="energy-container">
  <!-- 背景装饰 -->
  <view class="energy-bg-decoration">
    <view class="energy-bg-circle" style="width: 160rpx; height: 160rpx; top: 10%; right: -30rpx; animation-delay: 0s; opacity: 0.4;"></view>
    <view class="energy-bg-circle" style="width: 100rpx; height: 100rpx; top: 60%; left: -20rpx; animation-delay: 3s; opacity: 0.3;"></view>
    <view class="energy-bg-circle" style="width: 80rpx; height: 80rpx; top: 35%; right: 20%; animation-delay: 6s; opacity: 0.5;"></view>
  </view>

  <!-- 页面标题 -->
  <view class="energy-glass-card energy-p-32 energy-mb-24">
    <text class="energy-title-large energy-mb-8">添加设备</text>
    <text class="energy-text-tertiary energy-text-small">选择添加方式，快速连接您的智能设备</text>
  </view>

  <!-- 添加方式选择 -->
  <view class="energy-glass-card energy-p-24 energy-mb-24">
    <text class="energy-title-medium energy-mb-16">添加方式</text>
    
    <view class="add-methods">
      <view class="method-item {{addMethod === 'scan' ? 'active' : ''}}" 
            data-method="scan" bindtap="onMethodSelect">
        <view class="method-icon">
          <text class="energy-icon-text">📱</text>
        </view>
        <view class="method-info">
          <text class="energy-text-primary energy-text-medium energy-font-medium">扫码添加</text>
          <text class="energy-text-tertiary energy-text-small energy-mt-4">扫描设备二维码快速添加</text>
        </view>
        <view class="method-check">
          <view class="energy-radio {{addMethod === 'scan' ? 'checked' : ''}}"></view>
        </view>
      </view>
      
      <view class="method-item {{addMethod === 'manual' ? 'active' : ''}}" 
            data-method="manual" bindtap="onMethodSelect">
        <view class="method-icon">
          <text class="energy-icon-text">✏️</text>
        </view>
        <view class="method-info">
          <text class="energy-text-primary energy-text-medium energy-font-medium">手动添加</text>
          <text class="energy-text-tertiary energy-text-small energy-mt-4">手动输入设备信息</text>
        </view>
        <view class="method-check">
          <view class="energy-radio {{addMethod === 'manual' ? 'checked' : ''}}"></view>
        </view>
      </view>
      
      <view class="method-item {{addMethod === 'search' ? 'active' : ''}}" 
            data-method="search" bindtap="onMethodSelect">
        <view class="method-icon">
          <text class="energy-icon-text">🔍</text>
        </view>
        <view class="method-info">
          <text class="energy-text-primary energy-text-medium energy-font-medium">自动搜索</text>
          <text class="energy-text-tertiary energy-text-small energy-mt-4">自动搜索附近的智能设备</text>
        </view>
        <view class="method-check">
          <view class="energy-radio {{addMethod === 'search' ? 'checked' : ''}}"></view>
        </view>
      </view>
    </view>
  </view>

  <!-- 扫码添加 -->
  <view class="energy-glass-card energy-p-24 energy-mb-24" wx:if="{{addMethod === 'scan'}}">
    <text class="energy-title-medium energy-mb-16">扫描二维码</text>
    
    <view class="scan-container">
      <view class="scan-placeholder">
        <text class="energy-icon-text energy-text-large energy-mb-16">📷</text>
        <text class="energy-text-tertiary energy-text-small energy-mb-16">将设备二维码放入框内</text>
        <view class="energy-btn energy-btn-primary" bindtap="onStartScan">
          <text>开始扫描</text>
        </view>
      </view>
    </view>
    
    <view class="scan-tips energy-mt-24">
      <text class="energy-text-tertiary energy-text-small">💡 提示：二维码通常位于设备背面或说明书上</text>
    </view>
  </view>

  <!-- 手动添加 -->
  <view class="energy-glass-card energy-p-24 energy-mb-24" wx:if="{{addMethod === 'manual'}}">
    <text class="energy-title-medium energy-mb-16">设备信息</text>
    
    <view class="form-section">
      <!-- 设备类型 -->
      <view class="form-item energy-mb-24">
        <text class="energy-text-primary energy-text-medium energy-mb-12">设备类型</text>
        <view class="device-types">
          <view class="type-item {{deviceForm.type === 'power' ? 'active' : ''}}" 
                data-type="power" bindtap="onTypeSelect">
            <text class="energy-icon-text">⚡</text>
            <text class="energy-text-small">电力</text>
          </view>
          <view class="type-item {{deviceForm.type === 'water' ? 'active' : ''}}" 
                data-type="water" bindtap="onTypeSelect">
            <text class="energy-icon-text">💧</text>
            <text class="energy-text-small">水务</text>
          </view>
          <view class="type-item {{deviceForm.type === 'gas' ? 'active' : ''}}" 
                data-type="gas" bindtap="onTypeSelect">
            <text class="energy-icon-text">🔥</text>
            <text class="energy-text-small">燃气</text>
          </view>
          <view class="type-item {{deviceForm.type === 'carbon' ? 'active' : ''}}" 
                data-type="carbon" bindtap="onTypeSelect">
            <text class="energy-icon-text">🌱</text>
            <text class="energy-text-small">碳排放</text>
          </view>
        </view>
      </view>
      
      <!-- 设备名称 -->
      <view class="form-item energy-mb-24">
        <text class="energy-text-primary energy-text-medium energy-mb-12">设备名称</text>
        <input class="energy-input" 
               placeholder="请输入设备名称" 
               value="{{deviceForm.name}}"
               bindinput="onNameInput" />
      </view>
      
      <!-- 设备位置 -->
      <view class="form-item energy-mb-24">
        <text class="energy-text-primary energy-text-medium energy-mb-12">设备位置</text>
        <picker mode="selector" 
                range="{{locations}}" 
                value="{{deviceForm.locationIndex}}"
                bindchange="onLocationChange">
          <view class="energy-input picker-input">
            <text class="{{deviceForm.location ? 'energy-text-primary' : 'energy-text-tertiary'}}">
              {{deviceForm.location || '请选择设备位置'}}
            </text>
            <text class="energy-icon-text">▼</text>
          </view>
        </picker>
      </view>
      
      <!-- 设备ID -->
      <view class="form-item energy-mb-24">
        <text class="energy-text-primary energy-text-medium energy-mb-12">设备ID</text>
        <input class="energy-input" 
               placeholder="请输入设备唯一标识" 
               value="{{deviceForm.deviceId}}"
               bindinput="onDeviceIdInput" />
      </view>
      
      <!-- 设备密钥 -->
      <view class="form-item energy-mb-24">
        <text class="energy-text-primary energy-text-medium energy-mb-12">设备密钥</text>
        <input class="energy-input" 
               placeholder="请输入设备连接密钥" 
               value="{{deviceForm.secret}}"
               password="{{!showSecret}}"
               bindinput="onSecretInput" />
        <view class="secret-toggle" bindtap="onToggleSecret">
          <text class="energy-icon-text">{{showSecret ? '🙈' : '👁️'}}</text>
        </view>
      </view>
    </view>
  </view>

  <!-- 自动搜索 -->
  <view class="energy-glass-card energy-p-24 energy-mb-24" wx:if="{{addMethod === 'search'}}">
    <text class="energy-title-medium energy-mb-16">搜索设备</text>
    
    <view class="search-container">
      <view class="search-status" wx:if="{{!isSearching && foundDevices.length === 0}}">
        <text class="energy-icon-text energy-text-large energy-mb-16">📡</text>
        <text class="energy-text-tertiary energy-text-small energy-mb-16">点击开始搜索附近的智能设备</text>
        <view class="energy-btn energy-btn-primary" bindtap="onStartSearch">
          <text>开始搜索</text>
        </view>
      </view>
      
      <view class="search-loading" wx:if="{{isSearching}}">
        <view class="loading-animation">
          <view class="loading-dot"></view>
          <view class="loading-dot"></view>
          <view class="loading-dot"></view>
        </view>
        <text class="energy-text-primary energy-text-medium energy-mt-16">正在搜索设备...</text>
        <text class="energy-text-tertiary energy-text-small energy-mt-8">请确保设备已开启并处于配网模式</text>
      </view>
      
      <view class="found-devices" wx:if="{{foundDevices.length > 0}}">
        <text class="energy-text-primary energy-text-medium energy-mb-16">发现 {{foundDevices.length}} 个设备</text>
        
        <view class="device-list">
          <view class="device-item" wx:for="{{foundDevices}}" wx:key="id" 
                data-device="{{item}}" bindtap="onSelectFoundDevice">
            <view class="device-icon {{item.type}}">
              <text class="energy-icon-text">{{item.icon}}</text>
            </view>
            <view class="device-info">
              <text class="energy-text-primary energy-text-medium energy-font-medium">{{item.name}}</text>
              <text class="energy-text-tertiary energy-text-small energy-mt-4">{{item.model}} · 信号强度: {{item.signal}}</text>
            </view>
            <view class="device-select">
              <text class="energy-icon-text">▶</text>
            </view>
          </view>
        </view>
        
        <view class="search-actions energy-mt-24">
          <view class="energy-btn energy-btn-outline energy-btn-small" bindtap="onStartSearch">
            <text>重新搜索</text>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- 操作按钮 -->
  <view class="action-buttons">
    <view class="energy-btn energy-btn-outline" bindtap="onCancel">
      <text>取消</text>
    </view>
    <view class="energy-btn energy-btn-primary {{!canSubmit ? 'disabled' : ''}}" 
          bindtap="onSubmit">
      <text>添加设备</text>
    </view>
  </view>
</view>