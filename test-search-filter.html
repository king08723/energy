<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è®¾å¤‡æœç´¢å’Œç­›é€‰åŠŸèƒ½æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .search-section {
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .search-input {
            width: 300px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin-right: 10px;
        }

        .filter-tags {
            margin: 10px 0;
        }

        .filter-tag {
            display: inline-block;
            padding: 5px 15px;
            margin: 5px;
            background: #e9ecef;
            border: 1px solid #ddd;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .filter-tag.active {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }

        .device-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .device-info {
            flex: 1;
        }

        .device-name {
            font-weight: bold;
            font-size: 16px;
            margin-bottom: 5px;
        }

        .device-location {
            color: #666;
            font-size: 14px;
        }

        .device-type {
            color: #888;
            font-size: 12px;
        }

        .device-status-badge {
            display: flex;
            align-items: center;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
        }

        .device-status-badge.online {
            background: rgba(76, 175, 80, 0.1);
            color: #4CAF50;
        }

        .device-status-badge.offline {
            background: rgba(158, 158, 158, 0.1);
            color: #9E9E9E;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 5px;
        }

        .device-status-badge.online .status-dot {
            background: #4CAF50;
        }

        .device-status-badge.offline .status-dot {
            background: #9E9E9E;
        }

        .stats {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #333;
        }

        .stat-label {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }

        .test-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }

        .test-button:hover {
            background: #0056b3;
        }

        .test-result {
            margin: 10px 0;
            padding: 10px;
            background: #d4edda;
            border: 1px solid #c3e6cb;
            border-radius: 5px;
            color: #155724;
        }

        .test-error {
            background: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>è®¾å¤‡æœç´¢å’Œç­›é€‰åŠŸèƒ½æµ‹è¯•</h1>
        <p>æµ‹è¯•ä¿®å¤åçš„æœç´¢å’Œç­›é€‰åŠŸèƒ½ï¼ŒéªŒè¯ä¸­æ–‡æœç´¢ã€è®¾å¤‡ç±»å‹ç­›é€‰å’ŒçŠ¶æ€ç­›é€‰æ˜¯å¦æ­£å¸¸å·¥ä½œã€‚</p>

        <div class="search-section">
            <h3>æœç´¢åŠŸèƒ½æµ‹è¯•</h3>
            <input type="text" class="search-input" id="searchInput" placeholder="æœç´¢è®¾å¤‡åç§°ã€ç±»å‹æˆ–ä½ç½®"
                oninput="onSearchInput(event)">
            <button class="test-button" onclick="onSearchConfirm()">æœç´¢</button>
            <button class="test-button" onclick="onClearSearch()">æ¸…ç©º</button>

            <h3>ç­›é€‰åŠŸèƒ½æµ‹è¯•</h3>
            <div class="filter-tags">
                <span class="filter-tag active" data-type="all" onclick="onFilterType(event)">å…¨éƒ¨</span>
                <span class="filter-tag" data-type="meter" onclick="onFilterType(event)">ç”µè¡¨</span>
                <span class="filter-tag" data-type="sensor" onclick="onFilterType(event)">ä¼ æ„Ÿå™¨</span>
                <span class="filter-tag" data-type="switch" onclick="onFilterType(event)">å¼€å…³</span>
                <span class="filter-tag" data-type="hvac" onclick="onFilterType(event)">ç©ºè°ƒ</span>
            </div>

            <div class="filter-tags">
                <span class="filter-tag" data-type="offline" onclick="onFilterType(event)">ğŸ”´ ç¦»çº¿è®¾å¤‡</span>
                <span class="filter-tag" data-type="alert" onclick="onFilterType(event)">âš ï¸ å‘Šè­¦è®¾å¤‡</span>
                <span class="filter-tag" data-type="abnormal" onclick="onFilterType(event)">âš¡ å¼‚å¸¸è®¾å¤‡</span>
                <span class="filter-tag" data-type="healthy" onclick="onFilterType(event)">âœ… æ­£å¸¸è®¾å¤‡</span>
            </div>
        </div>

        <div class="stats">
            <div class="stat-item">
                <div class="stat-number" id="totalDevices">0</div>
                <div class="stat-label">æ€»è®¾å¤‡</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="filteredDevices">0</div>
                <div class="stat-label">ç­›é€‰ç»“æœ</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="onlineDevices">0</div>
                <div class="stat-label">åœ¨çº¿</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="offlineDevices">0</div>
                <div class="stat-label">ç¦»çº¿</div>
            </div>
        </div>

        <div>
            <button class="test-button" onclick="loadTestData()">åŠ è½½æµ‹è¯•æ•°æ®</button>
            <button class="test-button" onclick="runSearchTests()">è¿è¡Œæœç´¢æµ‹è¯•</button>
            <button class="test-button" onclick="runFilterTests()">è¿è¡Œç­›é€‰æµ‹è¯•</button>
            <button class="test-button" onclick="runConsistencyTests()">è¿è¡Œæ•°æ®ä¸€è‡´æ€§æµ‹è¯•</button>
            <button class="test-button" onclick="runDelayTests()">è¿è¡Œç­›é€‰å»¶è¿Ÿæµ‹è¯•</button>
        </div>

        <div id="testResults"></div>
        <div id="deviceList"></div>
    </div>

    <script>
        // æ¨¡æ‹Ÿè®¾å¤‡æ•°æ® - ä½¿ç”¨çœŸå®çš„è®¾å¤‡ç±»å‹æ˜ å°„
        let allDevices = [
            {
                id: 'device_001',
                name: 'ç”Ÿäº§è½¦é—´ç©ºè°ƒç³»ç»Ÿ',
                location: 'ç”Ÿäº§è½¦é—´AåŒº',
                type: 'air_conditioner', // çœŸå®ç±»å‹
                status: 'online',
                statusText: 'åœ¨çº¿',
                healthStatus: 'good',
                hasAlert: false,
                alerts: []
            },
            {
                id: 'device_002',
                name: 'åŠå…¬åŒºç…§æ˜å¼€å…³',
                location: 'åŠå…¬æ¥¼2å±‚',
                type: 'power_distribution', // çœŸå®ç±»å‹
                status: 'offline',
                statusText: 'ç¦»çº¿',
                healthStatus: 'warning',
                hasAlert: false,
                alerts: []
            },
            {
                id: 'device_003',
                name: 'æ¸©åº¦ä¼ æ„Ÿå™¨',
                location: 'ä»“åº“',
                type: 'environment_sensor', // çœŸå®ç±»å‹
                status: 'online',
                statusText: 'åœ¨çº¿',
                healthStatus: 'good',
                hasAlert: true,
                alerts: [{ severity: 'warning', message: 'æ¸©åº¦è¿‡é«˜' }]
            },
            {
                id: 'device_004',
                name: 'ä¸»ç”µè¡¨',
                location: 'é…ç”µæˆ¿',
                type: 'smart_meter', // çœŸå®ç±»å‹
                status: 'online',
                statusText: 'åœ¨çº¿',
                healthStatus: 'good',
                hasAlert: false,
                alerts: []
            },
            {
                id: 'device_005',
                name: 'å…‰ä¼é€†å˜å™¨',
                location: 'å±‹é¡¶',
                type: 'smart_meter', // çœŸå®ç±»å‹
                status: 'offline',
                statusText: 'ç¦»çº¿',
                healthStatus: 'error',
                hasAlert: true,
                alerts: [{ severity: 'critical', message: 'è®¾å¤‡ç¦»çº¿' }]
            },
            {
                id: 'device_006',
                name: 'Smart Water Meter',
                location: 'Building A',
                type: 'water_meter', // çœŸå®ç±»å‹
                status: 'online',
                statusText: 'åœ¨çº¿',
                healthStatus: 'good',
                hasAlert: false,
                alerts: []
            },
            {
                id: 'device_007',
                name: 'ç‡ƒæ°”æ£€æµ‹å™¨',
                location: 'ç‡ƒæ°”ç®¡é“åŒº',
                type: 'gas_detector', // çœŸå®ç±»å‹
                status: 'online',
                statusText: 'åœ¨çº¿',
                healthStatus: 'warning',
                hasAlert: true,
                alerts: [{ severity: 'warning', message: 'ç‡ƒæ°”æµ“åº¦åé«˜' }]
            },
            {
                id: 'device_008',
                name: 'çƒ­æ°´å™¨ç³»ç»Ÿ',
                location: 'å‘˜å·¥å®¿èˆ',
                type: 'water_heater', // çœŸå®ç±»å‹
                status: 'alarm',
                statusText: 'å‘Šè­¦',
                healthStatus: 'error',
                hasAlert: true,
                alerts: [{ severity: 'critical', message: 'èƒ½è€—å¼‚å¸¸' }]
            }
        ];

        let filteredDevices = [];
        let searchKeyword = '';
        let filterType = 'all';

        // æœç´¢å’Œç­›é€‰é€»è¾‘ - å¤åˆ¶è‡ªä¿®å¤åçš„ä»£ç 
        function applyFilters() {
            let filtered = allDevices;

            // åº”ç”¨æœç´¢å…³é”®è¯è¿‡æ»¤ - æ”¯æŒä¸­æ–‡æœç´¢
            if (searchKeyword && searchKeyword.trim()) {
                const keyword = searchKeyword.trim();

                filtered = filtered.filter(device => {
                    // ç¡®ä¿æ‰€æœ‰å­—æ®µéƒ½å­˜åœ¨ä¸”ä¸ºå­—ç¬¦ä¸²
                    const deviceName = (device.name || '').toString();
                    const deviceLocation = (device.location || '').toString();
                    const deviceType = (device.type || '').toString();
                    const deviceId = (device.id || '').toString();

                    // ä¸­æ–‡æœç´¢ï¼šç›´æ¥åŒ…å«åŒ¹é…ï¼Œä¸è½¬æ¢å¤§å°å†™
                    // è‹±æ–‡æœç´¢ï¼šè½¬æ¢ä¸ºå°å†™ååŒ¹é…
                    const isChineseKeyword = /[\u4e00-\u9fa5]/.test(keyword);

                    if (isChineseKeyword) {
                        // ä¸­æ–‡å…³é”®è¯ï¼šç›´æ¥åŒ¹é…
                        return deviceName.includes(keyword) ||
                            deviceLocation.includes(keyword) ||
                            deviceType.includes(keyword) ||
                            deviceId.includes(keyword);
                    } else {
                        // è‹±æ–‡å…³é”®è¯ï¼šè½¬æ¢ä¸ºå°å†™ååŒ¹é…
                        const lowerKeyword = keyword.toLowerCase();
                        return deviceName.toLowerCase().includes(lowerKeyword) ||
                            deviceLocation.toLowerCase().includes(lowerKeyword) ||
                            deviceType.toLowerCase().includes(lowerKeyword) ||
                            deviceId.toLowerCase().includes(lowerKeyword);
                    }
                });
            }

            // åº”ç”¨è®¾å¤‡ç±»å‹å’ŒçŠ¶æ€è¿‡æ»¤ - å¢å¼ºç©ºå€¼å¤„ç†
            if (filterType !== 'all') {
                if (filterType === 'offline') {
                    filtered = filtered.filter(device =>
                        (device.status || 'offline') === 'offline'
                    );
                } else if (filterType === 'alert') {
                    filtered = filtered.filter(device => {
                        // æ£€æŸ¥è®¾å¤‡æ˜¯å¦æœ‰å‘Šè­¦
                        const hasAlerts = device.alerts && Array.isArray(device.alerts) && device.alerts.length > 0;
                        const hasAlert = device.hasAlert === true;
                        return hasAlerts || hasAlert;
                    });
                } else if (filterType === 'abnormal') {
                    filtered = filtered.filter(device => {
                        const healthStatus = device.healthStatus || 'good';
                        const status = device.status || 'offline';
                        // ä¿®å¤å¼‚å¸¸è®¾å¤‡ç­›é€‰é€»è¾‘ï¼šåŒ…æ‹¬ç¦»çº¿ã€å‘Šè­¦ã€ç»´æŠ¤ã€é™çº§ç­‰çŠ¶æ€
                        return healthStatus === 'error' ||
                            healthStatus === 'warning' ||
                            status === 'offline' ||
                            status === 'alarm' ||
                            status === 'maintenance' ||
                            status === 'degraded' ||
                            (device.alerts && Array.isArray(device.alerts) && device.alerts.length > 0) ||
                            device.hasAlert === true;
                    });
                } else if (filterType === 'healthy') {
                    filtered = filtered.filter(device => {
                        const status = device.status || 'offline';
                        const healthStatus = device.healthStatus || 'good';
                        const hasAlerts = device.alerts && Array.isArray(device.alerts) && device.alerts.length > 0;
                        const hasAlert = device.hasAlert === true;

                        return status === 'online' &&
                            healthStatus === 'good' &&
                            !hasAlerts &&
                            !hasAlert;
                    });
                } else {
                    // è®¾å¤‡ç±»å‹è¿‡æ»¤ - ä½¿ç”¨ä¿®å¤åçš„ç±»å‹æ˜ å°„
                    filtered = filtered.filter(device => {
                        const deviceType = (device.type || '').toLowerCase();

                        // å»ºç«‹ç±»å‹æ˜ å°„å…³ç³»
                        const typeMapping = {
                            'meter': ['smart_meter', 'water_meter', 'gas_meter'], // ç”µè¡¨ç±»å‹
                            'sensor': ['environment_sensor', 'environment_monitor', 'gas_detector'], // ä¼ æ„Ÿå™¨ç±»å‹
                            'switch': ['power_distribution', 'smart_control'], // å¼€å…³ç±»å‹
                            'hvac': ['air_conditioner', 'water_heater', 'solar_water_heater', 'gas_boiler', 'cooling_water'] // ç©ºè°ƒç±»å‹
                        };

                        // æ£€æŸ¥æ˜¯å¦åŒ¹é…ç­›é€‰ç±»å‹
                        if (typeMapping[filterType]) {
                            return typeMapping[filterType].includes(deviceType);
                        }

                        // å¦‚æœæ²¡æœ‰æ˜ å°„ï¼Œç›´æ¥æ¯”è¾ƒç±»å‹
                        return deviceType === filterType.toLowerCase();
                    });
                }
            }

            filteredDevices = filtered;
            renderDevices();
            updateStats();
        }

        // æœç´¢è¾“å…¥å¤„ç†
        function onSearchInput(event) {
            searchKeyword = event.target.value;
            // å®æ—¶æœç´¢ï¼Œæ·»åŠ é˜²æŠ–
            debounceSearch();
        }

        let searchTimer = null;
        function debounceSearch() {
            if (searchTimer) {
                clearTimeout(searchTimer);
            }
            searchTimer = setTimeout(() => {
                applyFilters();
            }, 300);
        }

        function onSearchConfirm() {
            applyFilters();
        }

        function onClearSearch() {
            searchKeyword = '';
            document.getElementById('searchInput').value = '';
            applyFilters();
        }

        function onFilterType(event) {
            // æ›´æ–°ç­›é€‰ç±»å‹
            filterType = event.target.dataset.type;

            // æ›´æ–°UIçŠ¶æ€
            document.querySelectorAll('.filter-tag').forEach(tag => {
                tag.classList.remove('active');
            });
            event.target.classList.add('active');

            // å…ˆè®¡ç®—ç­›é€‰ç»“æœæ•°é‡ï¼Œæ¨¡æ‹Ÿä¿®å¤åçš„é€»è¾‘
            const filteredCount = calculateFilteredCount(filterType);

            // æ‰§è¡Œç­›é€‰
            applyFilters();

            // æ˜¾ç¤ºToastæç¤ºï¼Œä½¿ç”¨é¢„å…ˆè®¡ç®—çš„æ•°é‡
            if (filterType !== 'all') {
                const filterNames = {
                    'meter': 'ç”µè¡¨è®¾å¤‡',
                    'sensor': 'ä¼ æ„Ÿå™¨è®¾å¤‡',
                    'switch': 'å¼€å…³è®¾å¤‡',
                    'hvac': 'ç©ºè°ƒè®¾å¤‡',
                    'offline': 'ç¦»çº¿è®¾å¤‡',
                    'alert': 'å‘Šè­¦è®¾å¤‡',
                    'abnormal': 'å¼‚å¸¸è®¾å¤‡',
                    'healthy': 'æ­£å¸¸è®¾å¤‡'
                };
                const filterName = filterNames[filterType] || `${filterType}ç±»å‹è®¾å¤‡`;

                // æ¨¡æ‹ŸToastæç¤º
                addTestResult(`Toastæç¤º: å·²ç­›é€‰${filterName}ï¼š${filteredCount}ä¸ª`, false);
                addTestResult(`å®é™…ç­›é€‰ç»“æœ: ${filteredDevices.length}ä¸ª`, filteredCount !== filteredDevices.length);

                if (filteredCount === filteredDevices.length) {
                    addTestResult(`âœ… æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥é€šè¿‡`, false);
                } else {
                    addTestResult(`âŒ æ•°æ®ä¸ä¸€è‡´ï¼Toastæ˜¾ç¤º${filteredCount}ä¸ªï¼Œå®é™…${filteredDevices.length}ä¸ª`, true);
                }
            }
        }

        // è®¡ç®—ç­›é€‰ç»“æœæ•°é‡çš„å‡½æ•°ï¼Œå¤åˆ¶ä¿®å¤åçš„é€»è¾‘
        function calculateFilteredCount(targetFilterType) {
            let filtered = allDevices;
            const currentFilterType = targetFilterType || filterType;

            // åº”ç”¨æœç´¢å…³é”®è¯è¿‡æ»¤
            if (searchKeyword && searchKeyword.trim()) {
                const keyword = searchKeyword.trim();
                const isChineseKeyword = /[\u4e00-\u9fa5]/.test(keyword);

                if (isChineseKeyword) {
                    filtered = filtered.filter(device => {
                        const deviceName = (device.name || '').toString();
                        const deviceLocation = (device.location || '').toString();
                        const deviceType = (device.type || '').toString();
                        const deviceId = (device.id || '').toString();
                        return deviceName.includes(keyword) ||
                            deviceLocation.includes(keyword) ||
                            deviceType.includes(keyword) ||
                            deviceId.includes(keyword);
                    });
                } else {
                    const lowerKeyword = keyword.toLowerCase();
                    filtered = filtered.filter(device => {
                        const deviceName = (device.name || '').toString();
                        const deviceLocation = (device.location || '').toString();
                        const deviceType = (device.type || '').toString();
                        const deviceId = (device.id || '').toString();
                        return deviceName.toLowerCase().includes(lowerKeyword) ||
                            deviceLocation.toLowerCase().includes(lowerKeyword) ||
                            deviceType.toLowerCase().includes(lowerKeyword) ||
                            deviceId.toLowerCase().includes(lowerKeyword);
                    });
                }
            }

            // åº”ç”¨è®¾å¤‡ç±»å‹å’ŒçŠ¶æ€è¿‡æ»¤
            if (currentFilterType !== 'all') {
                if (currentFilterType === 'offline') {
                    filtered = filtered.filter(device =>
                        (device.status || 'offline') === 'offline'
                    );
                } else if (currentFilterType === 'alert') {
                    filtered = filtered.filter(device => {
                        const hasAlerts = device.alerts && Array.isArray(device.alerts) && device.alerts.length > 0;
                        const hasAlert = device.hasAlert === true;
                        return hasAlerts || hasAlert;
                    });
                } else if (currentFilterType === 'abnormal') {
                    filtered = filtered.filter(device => {
                        const healthStatus = device.healthStatus || 'good';
                        const status = device.status || 'offline';
                        return healthStatus === 'error' ||
                            healthStatus === 'warning' ||
                            status === 'offline' ||
                            status === 'alarm' ||
                            status === 'maintenance' ||
                            status === 'degraded' ||
                            (device.alerts && Array.isArray(device.alerts) && device.alerts.length > 0) ||
                            device.hasAlert === true;
                    });
                } else if (currentFilterType === 'healthy') {
                    filtered = filtered.filter(device => {
                        const status = device.status || 'offline';
                        const healthStatus = device.healthStatus || 'good';
                        const hasAlerts = device.alerts && Array.isArray(device.alerts) && device.alerts.length > 0;
                        const hasAlert = device.hasAlert === true;

                        return status === 'online' &&
                            healthStatus === 'good' &&
                            !hasAlerts &&
                            !hasAlert;
                    });
                } else {
                    // è®¾å¤‡ç±»å‹è¿‡æ»¤ - ä½¿ç”¨ä¿®å¤åçš„ç±»å‹æ˜ å°„
                    filtered = filtered.filter(device => {
                        const deviceType = (device.type || '').toLowerCase();

                        const typeMapping = {
                            'meter': ['smart_meter', 'water_meter', 'gas_meter'],
                            'sensor': ['environment_sensor', 'environment_monitor', 'gas_detector'],
                            'switch': ['power_distribution', 'smart_control'],
                            'hvac': ['air_conditioner', 'water_heater', 'solar_water_heater', 'gas_boiler', 'cooling_water']
                        };

                        if (typeMapping[currentFilterType]) {
                            return typeMapping[currentFilterType].includes(deviceType);
                        }

                        return deviceType === currentFilterType.toLowerCase();
                    });
                }
            }

            return filtered.length;
        }

        function updateStats() {
            const total = allDevices.length;
            const filtered = filteredDevices.length;
            const online = filteredDevices.filter(d => d.status === 'online').length;
            const offline = filteredDevices.filter(d => d.status === 'offline').length;

            document.getElementById('totalDevices').textContent = total;
            document.getElementById('filteredDevices').textContent = filtered;
            document.getElementById('onlineDevices').textContent = online;
            document.getElementById('offlineDevices').textContent = offline;
        }

        function renderDevices() {
            const deviceList = document.getElementById('deviceList');
            deviceList.innerHTML = '';

            if (filteredDevices.length === 0) {
                deviceList.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">æœªæ‰¾åˆ°åŒ¹é…çš„è®¾å¤‡</div>';
                return;
            }

            filteredDevices.forEach(device => {
                const deviceCard = document.createElement('div');
                deviceCard.className = 'device-card';
                deviceCard.innerHTML = `
                    <div class="device-info">
                        <div class="device-name">${device.name}</div>
                        <div class="device-location">${device.location}</div>
                        <div class="device-type">ç±»å‹: ${device.type}</div>
                    </div>
                    <div class="device-status-badge ${device.status}">
                        <div class="status-dot"></div>
                        <span class="status-text">${device.statusText}</span>
                        ${device.hasAlert ? ' âš ï¸' : ''}
                    </div>
                `;
                deviceList.appendChild(deviceCard);
            });
        }

        function loadTestData() {
            filteredDevices = [...allDevices];
            renderDevices();
            updateStats();
            addTestResult('æµ‹è¯•æ•°æ®å·²åŠ è½½ï¼Œå…± ' + allDevices.length + ' ä¸ªè®¾å¤‡', false);
        }

        function addTestResult(message, isError = false) {
            const resultsDiv = document.getElementById('testResults');
            const resultDiv = document.createElement('div');
            resultDiv.className = isError ? 'test-result test-error' : 'test-result';
            resultDiv.textContent = message;
            resultsDiv.appendChild(resultDiv);
        }

        function runSearchTests() {
            const tests = [
                { keyword: 'ç©ºè°ƒ', expected: 1, description: 'ä¸­æ–‡æœç´¢"ç©ºè°ƒ"' },
                { keyword: 'è½¦é—´', expected: 1, description: 'ä¸­æ–‡æœç´¢"è½¦é—´"' },
                { keyword: 'Smart', expected: 1, description: 'è‹±æ–‡æœç´¢"Smart"' },
                { keyword: 'meter', expected: 1, description: 'è‹±æ–‡æœç´¢"meter"ï¼ˆç±»å‹åŒ¹é…ï¼‰' },
                { keyword: 'ä¼ æ„Ÿå™¨', expected: 1, description: 'ä¸­æ–‡æœç´¢"ä¼ æ„Ÿå™¨"' },
                { keyword: 'æ£€æµ‹å™¨', expected: 1, description: 'ä¸­æ–‡æœç´¢"æ£€æµ‹å™¨"' },
                { keyword: 'çƒ­æ°´å™¨', expected: 1, description: 'ä¸­æ–‡æœç´¢"çƒ­æ°´å™¨"' },
                { keyword: 'ä¸å­˜åœ¨çš„è®¾å¤‡', expected: 0, description: 'æœç´¢ä¸å­˜åœ¨çš„è®¾å¤‡' },
                { keyword: 'ç©ºè°ƒ', expected: 1, description: 'é‡å¤æœç´¢æµ‹è¯•ï¼ˆé˜²æŠ–éªŒè¯ï¼‰' }
            ];

            addTestResult('å¼€å§‹æœç´¢åŠŸèƒ½æµ‹è¯•ï¼ˆåŒ…å«é˜²æŠ–éªŒè¯ï¼‰...', false);

            tests.forEach((test, index) => {
                // æ¨¡æ‹Ÿé˜²æŠ–å»¶è¿Ÿ
                setTimeout(() => {
                    searchKeyword = test.keyword;
                    document.getElementById('searchInput').value = test.keyword;
                    applyFilters();

                    const actualCount = filteredDevices.length;
                    const passed = actualCount === test.expected;
                    const message = `${test.description}: æœŸæœ› ${test.expected} ä¸ªï¼Œå®é™… ${actualCount} ä¸ª - ${passed ? 'é€šè¿‡' : 'å¤±è´¥'}`;
                    addTestResult(message, !passed);

                    // æœ€åä¸€ä¸ªæµ‹è¯•å®Œæˆåæ¸…ç©ºæœç´¢
                    if (index === tests.length - 1) {
                        setTimeout(() => onClearSearch(), 100);
                    }
                }, index * 100); // æ¨¡æ‹Ÿç”¨æˆ·å¿«é€Ÿè¾“å…¥
            });
        }

        function runFilterTests() {
            const tests = [
                { type: 'all', expected: 8, description: 'ç­›é€‰å…¨éƒ¨è®¾å¤‡' },
                { type: 'meter', expected: 3, description: 'ç­›é€‰ç”µè¡¨è®¾å¤‡ï¼ˆsmart_meter, water_meterï¼‰' },
                { type: 'sensor', expected: 2, description: 'ç­›é€‰ä¼ æ„Ÿå™¨è®¾å¤‡ï¼ˆenvironment_sensor, gas_detectorï¼‰' },
                { type: 'switch', expected: 1, description: 'ç­›é€‰å¼€å…³è®¾å¤‡ï¼ˆpower_distributionï¼‰' },
                { type: 'hvac', expected: 2, description: 'ç­›é€‰ç©ºè°ƒè®¾å¤‡ï¼ˆair_conditioner, water_heaterï¼‰' },
                { type: 'offline', expected: 1, description: 'ç­›é€‰ç¦»çº¿è®¾å¤‡' },
                { type: 'alert', expected: 3, description: 'ç­›é€‰å‘Šè­¦è®¾å¤‡' },
                { type: 'healthy', expected: 2, description: 'ç­›é€‰æ­£å¸¸è®¾å¤‡' },
                { type: 'abnormal', expected: 6, description: 'ç­›é€‰å¼‚å¸¸è®¾å¤‡ï¼ˆåŒ…æ‹¬ç¦»çº¿ã€å‘Šè­¦ã€è­¦å‘ŠçŠ¶æ€ï¼‰' }
            ];

            addTestResult('å¼€å§‹ç­›é€‰åŠŸèƒ½æµ‹è¯•...', false);

            tests.forEach(test => {
                filterType = test.type;
                applyFilters();

                const actualCount = filteredDevices.length;
                const passed = actualCount === test.expected;
                const message = `${test.description}: æœŸæœ› ${test.expected} ä¸ªï¼Œå®é™… ${actualCount} ä¸ª - ${passed ? 'é€šè¿‡' : 'å¤±è´¥'}`;
                addTestResult(message, !passed);
            });

            // é‡ç½®ç­›é€‰
            filterType = 'all';
            document.querySelectorAll('.filter-tag').forEach(tag => {
                tag.classList.remove('active');
            });
            document.querySelector('.filter-tag[data-type="all"]').classList.add('active');
            applyFilters();
        }

        function runConsistencyTests() {
            addTestResult('å¼€å§‹æ•°æ®ä¸€è‡´æ€§æµ‹è¯•...', false);

            const testCases = [
                { type: 'meter', description: 'ç”µè¡¨è®¾å¤‡ç­›é€‰ä¸€è‡´æ€§' },
                { type: 'sensor', description: 'ä¼ æ„Ÿå™¨è®¾å¤‡ç­›é€‰ä¸€è‡´æ€§' },
                { type: 'switch', description: 'å¼€å…³è®¾å¤‡ç­›é€‰ä¸€è‡´æ€§' },
                { type: 'hvac', description: 'ç©ºè°ƒè®¾å¤‡ç­›é€‰ä¸€è‡´æ€§' },
                { type: 'offline', description: 'ç¦»çº¿è®¾å¤‡ç­›é€‰ä¸€è‡´æ€§' },
                { type: 'alert', description: 'å‘Šè­¦è®¾å¤‡ç­›é€‰ä¸€è‡´æ€§' },
                { type: 'abnormal', description: 'å¼‚å¸¸è®¾å¤‡ç­›é€‰ä¸€è‡´æ€§' },
                { type: 'healthy', description: 'æ­£å¸¸è®¾å¤‡ç­›é€‰ä¸€è‡´æ€§' }
            ];

            testCases.forEach(testCase => {
                // è®¡ç®—é¢„æœŸçš„ç­›é€‰ç»“æœæ•°é‡
                const expectedCount = calculateFilteredCount(testCase.type);

                // æ‰§è¡Œå®é™…ç­›é€‰
                filterType = testCase.type;
                applyFilters();
                const actualCount = filteredDevices.length;

                // æ£€æŸ¥ä¸€è‡´æ€§
                const isConsistent = expectedCount === actualCount;
                const message = `${testCase.description}: Toastæ˜¾ç¤º${expectedCount}ä¸ªï¼Œå®é™…ç­›é€‰${actualCount}ä¸ª - ${isConsistent ? 'âœ… ä¸€è‡´' : 'âŒ ä¸ä¸€è‡´'}`;
                addTestResult(message, !isConsistent);
            });

            // é‡ç½®ç­›é€‰
            filterType = 'all';
            document.querySelectorAll('.filter-tag').forEach(tag => {
                tag.classList.remove('active');
            });
            document.querySelector('.filter-tag[data-type="all"]').classList.add('active');
            applyFilters();

            addTestResult('æ•°æ®ä¸€è‡´æ€§æµ‹è¯•å®Œæˆ', false);
        }

        function runDelayTests() {
            addTestResult('å¼€å§‹ç­›é€‰å»¶è¿Ÿæµ‹è¯•...', false);

            const testSequence = [
                { type: 'all', description: 'é‡ç½®ä¸ºå…¨éƒ¨è®¾å¤‡' },
                { type: 'meter', description: 'ç­›é€‰ç”µè¡¨è®¾å¤‡' },
                { type: 'sensor', description: 'ç­›é€‰ä¼ æ„Ÿå™¨è®¾å¤‡' },
                { type: 'switch', description: 'ç­›é€‰å¼€å…³è®¾å¤‡' },
                { type: 'hvac', description: 'ç­›é€‰ç©ºè°ƒè®¾å¤‡' },
                { type: 'all', description: 'é‡ç½®ä¸ºå…¨éƒ¨è®¾å¤‡' }
            ];

            let currentIndex = 0;

            function runNextTest() {
                if (currentIndex >= testSequence.length) {
                    addTestResult('ç­›é€‰å»¶è¿Ÿæµ‹è¯•å®Œæˆ', false);
                    return;
                }

                const testCase = testSequence[currentIndex];
                const previousType = currentIndex > 0 ? testSequence[currentIndex - 1].type : 'all';

                // æ¨¡æ‹Ÿç‚¹å‡»ç­›é€‰æŒ‰é’®
                filterType = testCase.type;

                // è®¡ç®—é¢„æœŸç»“æœ
                const expectedCount = calculateFilteredCount(testCase.type);

                // æ‰§è¡Œç­›é€‰
                applyFilters();
                const actualCount = filteredDevices.length;

                // æ£€æŸ¥æ˜¯å¦æ˜¾ç¤ºäº†æ­£ç¡®çš„ç»“æœï¼ˆè€Œä¸æ˜¯ä¸Šä¸€æ¬¡çš„ç»“æœï¼‰
                const isCorrect = expectedCount === actualCount;
                const message = `${testCase.description}: æœŸæœ›${expectedCount}ä¸ªï¼Œå®é™…${actualCount}ä¸ª - ${isCorrect ? 'âœ… æ­£ç¡®' : 'âŒ å»¶è¿Ÿ/é”™è¯¯'}`;
                addTestResult(message, !isCorrect);

                if (!isCorrect) {
                    addTestResult(`  å¯èƒ½æ˜¾ç¤ºäº†ä¸Šä¸€æ¬¡ç­›é€‰ç»“æœï¼ˆ${previousType}ï¼‰`, true);
                }

                currentIndex++;

                // å»¶è¿Ÿæ‰§è¡Œä¸‹ä¸€ä¸ªæµ‹è¯•ï¼Œæ¨¡æ‹Ÿç”¨æˆ·æ“ä½œé—´éš”
                setTimeout(runNextTest, 100);
            }

            runNextTest();
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.onload = function () {
            loadTestData();
        };
    </script>
</body>

</html>