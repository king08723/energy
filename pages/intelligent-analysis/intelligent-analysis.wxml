<!--pages/intelligent-analysis/intelligent-analysis.wxml-->
<view class="intelligent-analysis">
  <!-- é¡µé¢æ ‡é¢˜ -->
  <view class="page-header">
    <text class="page-title">æ™ºèƒ½åˆ†æ</text>
    <text class="page-subtitle">AIé©±åŠ¨çš„è®¾å¤‡å¥åº·ä¸èƒ½æ•ˆåˆ†æ</text>
  </view>

  <!-- åŠ è½½çŠ¶æ€ -->
  <view wx:if="{{loading}}" class="loading-container">
    <view class="loading-spinner"></view>
    <text class="loading-text">æ­£åœ¨åˆ†ææ•°æ®...</text>
  </view>

  <!-- ä¸»è¦å†…å®¹ -->
  <view wx:else class="main-content">
    <!-- æ ‡ç­¾é¡µå¯¼èˆª -->
    <view class="tab-nav">
      <view 
        class="tab-item {{selectedTab === 'devices' ? 'active' : ''}}"
        data-tab="devices"
        bindtap="onTabChange"
      >
        <text class="tab-icon">ğŸ“±</text>
        <text class="tab-text">è®¾å¤‡åˆ†æ</text>
      </view>
      <view 
        class="tab-item {{selectedTab === 'alerts' ? 'active' : ''}}"
        data-tab="alerts"
        bindtap="onTabChange"
      >
        <text class="tab-icon">âš ï¸</text>
        <text class="tab-text">å‘Šè­¦åˆ†æ</text>
      </view>
      <view 
        class="tab-item {{selectedTab === 'optimization' ? 'active' : ''}}"
        data-tab="optimization"
        bindtap="onTabChange"
      >
        <text class="tab-icon">ğŸš€</text>
        <text class="tab-text">ä¼˜åŒ–å»ºè®®</text>
      </view>
    </view>

    <!-- è®¾å¤‡åˆ†æé¡µé¢ -->
    <view wx:if="{{selectedTab === 'devices'}}" class="devices-analysis">
      <!-- è¿‡æ»¤å™¨ -->
      <view class="filter-bar">
        <view 
          class="filter-item {{filterType === 'all' ? 'active' : ''}}"
          data-filter="all"
          bindtap="onFilterChange"
        >
          å…¨éƒ¨
        </view>
        <view 
          class="filter-item {{filterType === 'high_risk' ? 'active' : ''}}"
          data-filter="high_risk"
          bindtap="onFilterChange"
        >
          é«˜é£é™©
        </view>
        <view 
          class="filter-item {{filterType === 'medium_risk' ? 'active' : ''}}"
          data-filter="medium_risk"
          bindtap="onFilterChange"
        >
          ä¸­é£é™©
        </view>
        <view 
          class="filter-item {{filterType === 'low_risk' ? 'active' : ''}}"
          data-filter="low_risk"
          bindtap="onFilterChange"
        >
          ä½é£é™©
        </view>
      </view>

      <!-- è®¾å¤‡åˆ—è¡¨ -->
      <view class="device-list">
        <!-- ç©ºçŠ¶æ€æç¤º -->
        <view wx:if="{{filteredDevices.length === 0}}" class="empty-state">
          <text class="empty-icon">ğŸ“±</text>
          <text class="empty-title">æš‚æ— è®¾å¤‡æ•°æ®</text>
          <text class="empty-description">
            {{filterType === 'all' ? 'å½“å‰æ²¡æœ‰è®¾å¤‡æ•°æ®' : 'å½“å‰ç­›é€‰æ¡ä»¶ä¸‹æ²¡æœ‰è®¾å¤‡'}}
          </text>
        </view>
        
        <!-- è®¾å¤‡å¡ç‰‡ -->
        <view 
          wx:for="{{filteredDevices}}"
          wx:key="id"
          class="device-card"
          data-device-id="{{item.id}}"
          bindtap="onDeviceDetail"
        >
          <!-- è®¾å¤‡åŸºæœ¬ä¿¡æ¯ -->
          <view class="device-header">
            <view class="device-info">
              <text class="device-name">{{item.name}}</text>
              <text class="device-location">{{item.location}}</text>
            </view>
            <view 
              class="risk-badge"
              style="background-color: {{item.intelligentAnalysis.riskLevel === 'high' ? '#ff4757' : item.intelligentAnalysis.riskLevel === 'medium' ? '#ffa502' : '#2ed573'}}"
            >
              {{item.intelligentAnalysis.riskLevel === 'high' ? 'é«˜é£é™©' : item.intelligentAnalysis.riskLevel === 'medium' ? 'ä¸­é£é™©' : 'ä½é£é™©'}}
            </view>
          </view>

          <!-- æ™ºèƒ½åˆ†æç»“æœ -->
          <view class="analysis-results">
            <!-- æ•ˆç‡åˆ†æ•° -->
            <view class="metric-item">
              <text class="metric-label">æ•ˆç‡åˆ†æ•°</text>
              <view class="metric-value">
                <text class="metric-number">{{item.intelligentAnalysis.efficiencyScore}}</text>
                <text class="metric-unit">åˆ†</text>
              </view>
            </view>

            <!-- é¢„æµ‹æ•…éšœ -->
            <view class="metric-item">
              <text class="metric-label">æ•…éšœé¢„æµ‹</text>
              <view class="metric-value">
                <text class="metric-status {{item.intelligentAnalysis.predictedFailure ? 'warning' : 'normal'}}">
                  {{item.intelligentAnalysis.predictedFailure ? 'å¯èƒ½æ•…éšœ' : 'æ­£å¸¸'}}
                </text>
              </view>
            </view>

            <!-- ç»´æŠ¤å»ºè®® -->
            <view class="metric-item">
              <text class="metric-label">ç»´æŠ¤å»ºè®®</text>
              <view class="metric-value">
                <text class="metric-status {{item.intelligentAnalysis.maintenanceRecommended ? 'warning' : 'normal'}}">
                  {{item.intelligentAnalysis.maintenanceRecommended ? 'éœ€è¦ç»´æŠ¤' : 'æ— éœ€ç»´æŠ¤'}}
                </text>
              </view>
            </view>
          </view>

          <!-- æ ¹å› åˆ†æ -->
          <view class="root-cause-analysis">
            <view class="analysis-header">
              <text class="analysis-title">æ ¹å› åˆ†æ</text>
              <text class="confidence-score">ç½®ä¿¡åº¦: {{item.intelligentAnalysis.rootCauseAnalysis.confidence}}%</text>
            </view>
            <view class="primary-cause">
              <text class="cause-label">ä¸»è¦åŸå› :</text>
              <text class="cause-text">
                {{item.intelligentAnalysis.rootCauseAnalysis.primaryCause === 'network_issue' ? 'ç½‘ç»œé—®é¢˜' : 
                  item.intelligentAnalysis.rootCauseAnalysis.primaryCause === 'hardware_fault' ? 'ç¡¬ä»¶æ•…éšœ' :
                  item.intelligentAnalysis.rootCauseAnalysis.primaryCause === 'software_error' ? 'è½¯ä»¶é”™è¯¯' : 'ç¯å¢ƒå› ç´ '}}
              </text>
            </view>
          </view>

          <!-- å½±å“è¯„ä¼° -->
          <view class="impact-assessment">
            <text class="assessment-title">å½±å“è¯„ä¼°</text>
            <view class="impact-metrics">
              <view class="impact-item">
                <text class="impact-label">èƒ½è€—æŸå¤±</text>
                <text class="impact-value">{{item.intelligentAnalysis.impactAssessment.energyLoss}} kWh</text>
              </view>
              <view class="impact-item">
                <text class="impact-label">æˆæœ¬å½±å“</text>
                <text class="impact-value">Â¥{{item.intelligentAnalysis.impactAssessment.costImpact}}</text>
              </view>
              <view class="impact-item">
                <text class="impact-label">ç¢³æ’æ”¾</text>
                <text class="impact-value">{{item.intelligentAnalysis.impactAssessment.carbonImpact}} kg</text>
              </view>
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- å‘Šè­¦åˆ†æé¡µé¢ -->
    <view wx:elif="{{selectedTab === 'alerts'}}" class="alerts-analysis">
      <view class="alert-summary">
        <text class="summary-title">å‘Šè­¦æ¦‚è§ˆ</text>
        <view class="summary-stats">
          <view class="stat-item">
            <text class="stat-number">{{alertStats.total}}</text>
            <text class="stat-label">æ€»å‘Šè­¦æ•°</text>
          </view>
          <view class="stat-item">
            <text class="stat-number">{{alertStats.critical}}</text>
            <text class="stat-label">ä¸¥é‡å‘Šè­¦</text>
          </view>
          <view class="stat-item">
            <text class="stat-number">{{alertStats.major}}</text>
            <text class="stat-label">ä¸»è¦å‘Šè­¦</text>
          </view>
          <view class="stat-item">
            <text class="stat-number">{{alertStats.minor}}</text>
            <text class="stat-label">æ¬¡è¦å‘Šè­¦</text>
          </view>
          <view class="stat-item">
            <text class="stat-number">{{alertStats.unread}}</text>
            <text class="stat-label">æœªå¤„ç†</text>
          </view>
        </view>
      </view>

      <!-- å‘Šè­¦åˆ—è¡¨ -->
      <view class="alert-list">
        <!-- ç©ºçŠ¶æ€æç¤º -->
        <view wx:if="{{alerts.length === 0}}" class="empty-state">
          <text class="empty-icon">âš ï¸</text>
          <text class="empty-title">æš‚æ— å‘Šè­¦æ•°æ®</text>
          <text class="empty-description">å½“å‰ç³»ç»Ÿè¿è¡Œæ­£å¸¸ï¼Œæ²¡æœ‰å‘Šè­¦ä¿¡æ¯</text>
        </view>
        
        <!-- å‘Šè­¦å¡ç‰‡ -->
        <view 
          wx:for="{{alerts}}"
          wx:key="id"
          class="alert-card"
          data-alert-id="{{item.id}}"
          bindtap="onAlertDetail"
        >
          <view class="alert-header">
            <view class="alert-info">
              <text class="alert-title">{{item.title}}</text>
              <text class="alert-device">{{item.deviceName}}</text>
            </view>
            <view class="alert-level {{item.level}}">
              {{item.level === 'critical' ? 'ä¸¥é‡' : item.level === 'warning' ? 'è­¦å‘Š' : item.level === 'info' ? 'ä¿¡æ¯' : 'æœªçŸ¥'}}
            </view>
          </view>
          <view class="alert-content">
            <text class="alert-description">{{item.content}}</text>
          </view>
          <view class="alert-footer">
            <text class="alert-time">{{item.createTime}}</text>
            <text class="alert-status">{{item.status === 'unread' ? 'æœªè¯»' : item.status === 'read' ? 'å·²è¯»' : item.status === 'ignored' ? 'å·²å¿½ç•¥' : item.status === 'resolved' ? 'å·²è§£å†³' : 'æœªçŸ¥'}}</text>
          </view>
        </view>
      </view>
    </view>

    <!-- ä¼˜åŒ–å»ºè®®é¡µé¢ -->
    <view wx:elif="{{selectedTab === 'optimization'}}" class="optimization-recommendations">
      <view class="recommendations-header">
        <text class="recommendations-title">æ™ºèƒ½ä¼˜åŒ–å»ºè®®</text>
        <text class="recommendations-subtitle">åŸºäºAIåˆ†æçš„ä¸ªæ€§åŒ–ä¼˜åŒ–æ–¹æ¡ˆ</text>
      </view>

      <!-- å»ºè®®åˆ—è¡¨ -->
      <view class="recommendation-list">
        <view 
          wx:for="{{optimizationRecommendations}}"
          wx:key="id"
          class="recommendation-card"
        >
          <!-- å»ºè®®å¤´éƒ¨ -->
          <view class="recommendation-header">
            <view class="recommendation-info">
              <text class="recommendation-title">{{item.title}}</text>
              <view class="recommendation-type {{item.type}}">
                {{item.type === 'urgent' ? 'ç´§æ€¥' : item.type === 'maintenance' ? 'ç»´æŠ¤' : 'ä¼˜åŒ–'}}
              </view>
            </view>
            <view class="priority-badge">
              <text class="priority-text">ä¼˜å…ˆçº§ {{item.priority}}</text>
            </view>
          </view>

          <!-- å»ºè®®æè¿° -->
          <view class="recommendation-description">
            <text class="description-text">{{item.description}}</text>
          </view>

          <!-- å½±å“è®¾å¤‡ -->
          <view class="affected-devices">
            <text class="devices-label">å½±å“è®¾å¤‡:</text>
            <view class="devices-list">
              <text 
                wx:for="{{item.devices}}"
                wx:for-item="device"
                wx:key="*this"
                class="device-tag"
              >
                {{device}}
              </text>
            </view>
          </view>

          <!-- é¢„æœŸæ”¶ç›Š -->
          <view class="estimated-savings">
            <text class="savings-title">é¢„æœŸæ”¶ç›Š</text>
            <view class="savings-metrics">
              <view class="savings-item">
                <text class="savings-label">èŠ‚èƒ½</text>
                <text class="savings-value">{{item.estimatedSavings.energy}} kWh</text>
              </view>
              <view class="savings-item">
                <text class="savings-label">èŠ‚è´¹</text>
                <text class="savings-value">Â¥{{item.estimatedSavings.cost}}</text>
              </view>
              <view class="savings-item">
                <text class="savings-label">å‡æ’</text>
                <text class="savings-value">{{item.estimatedSavings.carbon}} kg</text>
              </view>
            </view>
          </view>

          <!-- æ‰§è¡ŒæŒ‰é’® -->
          <view class="recommendation-actions">
            <button 
              class="execute-btn"
              data-recommendation-id="{{item.id}}"
              bindtap="onExecuteRecommendation"
            >
              æ‰§è¡Œå»ºè®®
            </button>
          </view>
        </view>
      </view>
    </view>
  </view>
  <custom-footer></custom-footer>
</view>