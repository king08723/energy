<!--pages/monitor/monitor.wxml-->
<view class="energy-container">
  <!-- èƒŒæ™¯è£…é¥° -->
  <view class="energy-bg-decoration">
    <view class="energy-bg-circle" style="width: 220rpx; height: 220rpx; top: 5%; right: -60rpx; animation-delay: 0s; opacity: 0.6;"></view>
    <view class="energy-bg-circle" style="width: 180rpx; height: 180rpx; top: 40%; left: -40rpx; animation-delay: 2s; opacity: 0.5;"></view>
    <view class="energy-bg-circle" style="width: 150rpx; height: 150rpx; top: 70%; right: 10%; animation-delay: 4s; opacity: 0.4;"></view>
    <view class="energy-bg-circle" style="width: 100rpx; height: 100rpx; top: 20%; left: 15%; animation-delay: 6s; opacity: 0.3;"></view>
  </view>

  <!-- åŠ è½½çŠ¶æ€ -->
  <view class="loading-container" wx:if="{{isLoading}}">
    <view class="energy-loading"></view>
    <text class="energy-text-secondary">åŠ è½½ä¸­...</text>
  </view>

  <!-- ä¸»å†…å®¹åŒºåŸŸ -->
  <view class="monitor-content" wx:else>
    <!-- é¡µé¢æ ‡é¢˜ä¸è®¾å¤‡ä¿¡æ¯ -->
    <view class="energy-glass-card energy-p-24 energy-mb-16">
      <view class="energy-flex energy-flex-between energy-mb-16">
        <view class="energy-flex energy-flex-align-center">
          <view class="back-button" bindtap="onBack">
            <text class="energy-icon-text">â†</text>
          </view>
          <text class="energy-title-medium energy-ml-16">
            <!-- æ ¹æ®æ¨¡å¼æ˜¾ç¤ºä¸åŒæ ‡é¢˜ -->
            <block wx:if="{{mode === 'category'}}">{{categoryData.title}}ç›‘æ§</block>
            <block wx:else>å®æ—¶ç›‘æ§è¯¦æƒ…</block>
          </text>
        </view>
        <view class="refresh-button" bindtap="onRefresh">
          <text class="energy-icon-text">ğŸ”„</text>
        </view>
      </view>

      <!-- è®¾å¤‡åŸºæœ¬ä¿¡æ¯ - ä»…åœ¨è®¾å¤‡è¯¦æƒ…æ¨¡å¼æˆ–æ€»è§ˆæ¨¡å¼ä¸‹æ˜¾ç¤º -->
      <view class="device-info-container energy-flex energy-flex-between" wx:if="{{mode !== 'category'}}">
        <view class="device-basic-info">
          <text class="energy-title-small energy-mb-8">{{deviceInfo.name}}</text>
          <view class="device-meta energy-flex energy-flex-align-center">
            <view class="device-status {{deviceInfo.status}}">
              <text>{{deviceInfo.status === 'online' ? 'åœ¨çº¿' : 'ç¦»çº¿'}}</text>
            </view>
            <text class="energy-text-tertiary energy-text-small energy-ml-16">{{deviceInfo.type}}</text>
          </view>
        </view>
        
        <!-- ä¿¡å·å¼ºåº¦æŒ‡ç¤ºå™¨ -->
        <view class="signal-strength-container">
          <view class="signal-strength">
            <view class="signal-bar {{signalStrength >= 1 ? 'active' : ''}}"></view>
            <view class="signal-bar {{signalStrength >= 2 ? 'active' : ''}}"></view>
            <view class="signal-bar {{signalStrength >= 3 ? 'active' : ''}}"></view>
            <view class="signal-bar {{signalStrength >= 4 ? 'active' : ''}}"></view>
          </view>
          <text class="energy-text-tertiary energy-text-small">ä¿¡å·å¼ºåº¦</text>
        </view>
      </view>
      
      <!-- åˆ†ç±»æ±‡æ€»ä¿¡æ¯ - ä»…åœ¨åˆ†ç±»æ±‡æ€»æ¨¡å¼ä¸‹æ˜¾ç¤º -->
      <view class="category-info-container" wx:if="{{mode === 'category'}}">
        <view class="category-overview energy-flex energy-flex-between energy-mb-16">
          <view class="category-value-container">
            <text class="category-value energy-text-glow">{{categoryData.totalValue}}<text class="category-unit">{{categoryData.unit}}</text></text>
            <text class="energy-text-tertiary energy-text-small">æ€»{{categoryData.title}}</text>
          </view>
          <view class="category-meta">
            <view class="category-trend {{categoryData.trend.startsWith('+') ? 'up' : 'down'}}">
              <text>{{categoryData.trend}}</text>
            </view>
            <text class="energy-text-tertiary energy-text-small">è®¾å¤‡æ•°é‡: {{categoryData.devices}}</text>
          </view>
        </view>
      </view>
    </view>

    <!-- æ—¶é—´èŒƒå›´é€‰æ‹©å™¨ -->
    <view class="energy-glass-card energy-p-24 energy-mb-16">
      <view class="time-range-selector energy-flex">
        <view 
          class="time-range-item {{timeRange === '1h' ? 'active' : ''}}"
          bindtap="onTimeRangeChange"
          data-range="1h"
        >1å°æ—¶</view>
        <view 
          class="time-range-item {{timeRange === '6h' ? 'active' : ''}}"
          bindtap="onTimeRangeChange"
          data-range="6h"
        >6å°æ—¶</view>
        <view 
          class="time-range-item {{timeRange === '12h' ? 'active' : ''}}"
          bindtap="onTimeRangeChange"
          data-range="12h"
        >12å°æ—¶</view>
        <view 
          class="time-range-item {{timeRange === '24h' ? 'active' : ''}}"
          bindtap="onTimeRangeChange"
          data-range="24h"
        >24å°æ—¶</view>
        <view 
          class="time-range-item {{timeRange === '7d' ? 'active' : ''}}"
          bindtap="onTimeRangeChange"
          data-range="7d"
        >7å¤©</view>
      </view>
    </view>

    <!-- èƒ½è€—æ›²çº¿å›¾è¡¨ -->
    <view class="energy-glass-card energy-p-24 energy-mb-16">
      <view class="energy-title-small energy-mb-16">åˆ†æ—¶èƒ½è€—æ›²çº¿</view>
      <view class="energy-chart-container">
        <!-- ä½¿ç”¨å¾®ä¿¡å°ç¨‹åºåŸç”Ÿcanvasç»„ä»¶ -->
        <view class="energy-chart-placeholder" wx:if="{{!chartRendered}}">
          <text class="energy-text-tertiary">å›¾è¡¨åŠ è½½ä¸­...</text>
        </view>
        <view class="energy-chart-native" wx:else>
          <!-- å¯ç”¨canvasç»„ä»¶æ˜¾ç¤ºåˆ†æ—¶è€—èƒ½æ›²çº¿ï¼Œä½¿ç”¨Canvas 2Dæ¥å£æ”¯æŒåŒå±‚æ¸²æŸ“ -->
          <canvas type="2d" id="energyChart" style="width: 100%; height: 200px;"></canvas>
        </view>
      </view>
    </view>

    <!-- å®æ—¶å‚æ•° -->
    <view class="energy-glass-card energy-p-24 energy-mb-16" wx:if="{{mode !== 'category'}}">
      <view class="energy-title-small energy-mb-16">å®æ—¶å‚æ•°</view>
      <view class="params-grid">
        <view class="param-item">
          <text class="param-value energy-text-glow">{{realTimeParams.power}}<text class="param-unit">kW</text></text>
          <text class="param-label energy-text-tertiary">å½“å‰åŠŸç‡</text>
        </view>
        <view class="param-item">
          <text class="param-value energy-text-glow">{{realTimeParams.voltage}}<text class="param-unit">V</text></text>
          <text class="param-label energy-text-tertiary">ç”µå‹</text>
        </view>
        <view class="param-item">
          <text class="param-value energy-text-glow">{{realTimeParams.current}}<text class="param-unit">A</text></text>
          <text class="param-label energy-text-tertiary">ç”µæµ</text>
        </view>
        <view class="param-item">
          <text class="param-value energy-text-glow">{{realTimeParams.frequency}}<text class="param-unit">Hz</text></text>
          <text class="param-label energy-text-tertiary">é¢‘ç‡</text>
        </view>
        <view class="param-item">
          <text class="param-value energy-text-glow">{{realTimeParams.powerFactor}}</text>
          <text class="param-label energy-text-tertiary">åŠŸç‡å› æ•°</text>
        </view>
      </view>
    </view>
    
    <!-- åˆ†ç±»åˆ†å¸ƒ - ä»…åœ¨åˆ†ç±»æ±‡æ€»æ¨¡å¼ä¸‹æ˜¾ç¤º -->
    <view class="energy-glass-card energy-p-24 energy-mb-16" wx:if="{{mode === 'category'}}">
      <view class="energy-title-small energy-mb-16">åˆ†å¸ƒæƒ…å†µ</view>
      <view class="distribution-container">
        <!-- åˆ†å¸ƒæ¡å½¢å›¾ -->
        <view class="distribution-bars">
          <view class="distribution-bar-item" wx:for="{{categoryData.distribution}}" wx:key="name">
            <view class="distribution-bar-label">
              <text>{{item.name}}</text>
              <text class="distribution-bar-value">{{item.value}} {{categoryData.unit}}</text>
            </view>
            <view class="distribution-bar-container">
              <view class="distribution-bar-fill" style="width: {{item.percentage}}%;"></view>
              <text class="distribution-bar-percentage">{{item.percentage}}%</text>
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- ç¯å¢ƒå‚æ•° -->
    <view class="energy-glass-card energy-p-24 energy-mb-16" wx:if="{{mode !== 'category'}}">
      <view class="energy-title-small energy-mb-16">ç¯å¢ƒå‚æ•°</view>
      <view class="params-grid">
        <view class="param-item">
          <text class="param-value energy-text-glow">{{environmentParams.temperature}}<text class="param-unit">Â°C</text></text>
          <text class="param-label energy-text-tertiary">æ¸©åº¦</text>
        </view>
        <view class="param-item">
          <text class="param-value energy-text-glow">{{environmentParams.humidity}}<text class="param-unit">%</text></text>
          <text class="param-label energy-text-tertiary">æ¹¿åº¦</text>
        </view>
        <view class="param-item">
          <text class="param-value energy-text-glow">{{environmentParams.airQuality}}</text>
          <text class="param-label energy-text-tertiary">ç©ºæ°”è´¨é‡</text>
        </view>
      </view>
    </view>

    <!-- å‘Šè­¦åˆ—è¡¨ -->
    <view class="energy-glass-card energy-p-24 energy-mb-16" wx:if="{{mode !== 'category'}}">
      <view class="energy-flex energy-flex-between energy-mb-16">
        <text class="energy-title-small">å‘Šè­¦ä¿¡æ¯</text>
        <view class="energy-btn energy-btn-outline energy-btn-small" wx:if="{{alerts.length > 0}}" bindtap="onViewAllAlerts">
          <text>æŸ¥çœ‹å…¨éƒ¨</text>
        </view>
      </view>
      
      <!-- æ— å‘Šè­¦æç¤º -->
      <view class="no-alerts" wx:if="{{alerts.length === 0}}">
        <text class="energy-text-tertiary">æš‚æ— å‘Šè­¦ä¿¡æ¯</text>
      </view>
      
      <!-- å‘Šè­¦åˆ—è¡¨ -->
      <view class="alert-list" wx:else>
        <view class="alert-item {{item.level}}" wx:for="{{alerts}}" wx:key="id" bindtap="onViewAlert" data-id="{{item.id}}">
          <view class="alert-icon {{item.level}}"></view>
          <view class="alert-content">
            <text class="alert-title">{{item.title}}</text>
            <text class="alert-message">{{item.message}}</text>
            <text class="alert-time">{{item.time}}</text>
          </view>
          <view class="alert-arrow"></view>
        </view>
      </view>
    </view>

    <!-- è¿æ¥çŠ¶æ€æŒ‡ç¤ºå™¨ -->
    <view class="connection-status {{connected ? 'connected' : 'disconnected'}}">
      <text>{{connected ? 'å®æ—¶æ•°æ®å·²è¿æ¥' : 'å®æ—¶æ•°æ®è¿æ¥æ–­å¼€'}}</text>
    </view>
  </view>
</view>