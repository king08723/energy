<!--pages/automation/automation.wxml-->
<view class="energy-container">
  <!-- èƒŒæ™¯è£…é¥° -->
  <view class="energy-bg-decoration">
    <view class="energy-bg-circle" style="width: 200rpx; height: 200rpx; top: 10%; right: -50rpx; animation-delay: 0s; opacity: 0.6;"></view>
    <view class="energy-bg-circle" style="width: 150rpx; height: 150rpx; top: 60%; left: -30rpx; animation-delay: 2s; opacity: 0.4;"></view>
    <view class="energy-bg-circle" style="width: 120rpx; height: 120rpx; top: 40%; right: 20%; animation-delay: 4s; opacity: 0.5;"></view>
  </view>
  
  <!-- é¡µé¢æ ‡é¢˜ -->
  <view class="energy-glass-card energy-p-32">
    <view class="energy-flex energy-flex-between energy-mb-24">
      <text class="energy-title-large">è‡ªåŠ¨åŒ–è§„åˆ™</text>
      <view class="energy-flex">
        <!-- å®æ—¶åˆ·æ–°æŒ‡ç¤ºå™¨ -->
        <view class="refresh-indicator {{isRefreshing ? 'active' : ''}}" bindtap="onRefresh">
          <text class="energy-icon-text">ğŸ”„</text>
        </view>
      </view>
    </view>
    
    <!-- è§„åˆ™ç»Ÿè®¡ -->
    <view class="energy-flex energy-flex-between energy-mb-24">
      <view class="rule-stat-item">
        <text class="energy-text-tertiary energy-text-small">è§„åˆ™æ€»æ•°</text>
        <text class="energy-title-medium energy-text-primary">{{ruleStats.total || 0}}</text>
      </view>
      <view class="rule-stat-item">
        <text class="energy-text-tertiary energy-text-small">å·²å¯ç”¨</text>
        <text class="energy-title-medium energy-text-success">{{ruleStats.enabled || 0}}</text>
      </view>
      <view class="rule-stat-item">
        <text class="energy-text-tertiary energy-text-small">å·²æ‰§è¡Œ</text>
        <text class="energy-title-medium energy-text-primary">{{ruleStats.executed || 0}}æ¬¡</text>
      </view>
    </view>
  </view>

  <!-- æ·»åŠ è§„åˆ™æŒ‰é’® -->
  <view class="energy-glass-card energy-p-24 add-rule-card" bindtap="onAddRule">
    <view class="energy-flex energy-flex-center">
      <view class="add-icon">+</view>
      <text class="energy-text-secondary energy-text-medium">æ·»åŠ è‡ªåŠ¨åŒ–è§„åˆ™</text>
    </view>
  </view>

  <!-- è§„åˆ™ç±»å‹ç­›é€‰ -->
  <view class="energy-glass-card energy-p-24">
    <view class="energy-flex energy-flex-between energy-mb-16">
      <text class="energy-title-medium">è§„åˆ™åˆ—è¡¨</text>
      <view class="rule-filter" bindtap="toggleFilter">
        <text class="energy-text-tertiary energy-text-small">{{filterType === 'all' ? 'å…¨éƒ¨' : filterType === 'time' ? 'å®šæ—¶' : filterType === 'condition' ? 'æ¡ä»¶' : 'åœºæ™¯'}}</text>
        <text class="filter-icon">âŒ„</text>
      </view>
    </view>
    
    <!-- ç­›é€‰ä¸‹æ‹‰èœå• -->
    <view class="filter-dropdown" wx:if="{{showFilter}}">
      <view class="filter-item {{filterType === 'all' ? 'active' : ''}}" bindtap="onFilterType" data-type="all">
        <text>å…¨éƒ¨è§„åˆ™</text>
      </view>
      <view class="filter-item {{filterType === 'time' ? 'active' : ''}}" bindtap="onFilterType" data-type="time">
        <text>å®šæ—¶è§„åˆ™</text>
      </view>
      <view class="filter-item {{filterType === 'condition' ? 'active' : ''}}" bindtap="onFilterType" data-type="condition">
        <text>æ¡ä»¶è§„åˆ™</text>
      </view>
      <view class="filter-item {{filterType === 'scene' ? 'active' : ''}}" bindtap="onFilterType" data-type="scene">
        <text>åœºæ™¯è§„åˆ™</text>
      </view>
    </view>
    
    <!-- è§„åˆ™åˆ—è¡¨ -->
    <view class="rule-list">
      <view class="rule-empty" wx:if="{{filteredRules.length === 0}}">
        <text class="energy-text-muted">æš‚æ— è‡ªåŠ¨åŒ–è§„åˆ™</text>
      </view>
      
      <view class="rule-item energy-glass-card energy-p-16" wx:for="{{filteredRules}}" wx:key="id" bindtap="onRuleDetail" data-id="{{item.id}}">
        <view class="rule-header energy-flex energy-flex-between">
          <view class="rule-title-area">
            <text class="rule-icon">{{item.trigger.type === 'time' ? 'â±ï¸' : item.trigger.type === 'condition' ? 'ğŸ”„' : 'ğŸ™ï¸'}}</text>
            <text class="energy-title-small">{{item.name}}</text>
          </view>
          <view class="rule-status {{item.enabled ? 'enabled' : ''}}">
            <switch class="energy-switch-small" checked="{{item.enabled}}" bindchange="onToggleRule" data-id="{{item.id}}" catchtap="onSwitchTap"/>
          </view>
        </view>
        
        <view class="rule-description">
          <text class="energy-text-muted">{{item.description}}</text>
        </view>
        
        <view class="rule-footer energy-flex energy-flex-between">
          <view class="rule-trigger">
            <text class="energy-text-tertiary energy-text-small">{{item.trigger.type === 'time' ? 'å®šæ—¶è§¦å‘' : item.trigger.type === 'condition' ? 'æ¡ä»¶è§¦å‘' : 'åœºæ™¯è§¦å‘'}}</text>
          </view>
          <view class="rule-stats">
            <text class="energy-text-tertiary energy-text-small">å·²æ‰§è¡Œ {{item.executeCount}} æ¬¡</text>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- è§„åˆ™è¯¦æƒ…å¼¹çª— -->
  <view class="rule-detail-modal" wx:if="{{showRuleDetail}}">
    <view class="rule-detail-content energy-glass-card">
      <view class="rule-detail-header">
        <text class="energy-title-medium">è§„åˆ™è¯¦æƒ…</text>
        <view class="close-btn" bindtap="onCloseDetail">Ã—</view>
      </view>
      
      <view class="rule-detail-body">
        <!-- è§„åˆ™åŸºæœ¬ä¿¡æ¯ -->
        <view class="detail-section">
          <text class="energy-title-small energy-mb-8">åŸºæœ¬ä¿¡æ¯</text>
          <view class="detail-item">
            <text class="energy-text-tertiary">è§„åˆ™åç§°ï¼š</text>
            <text class="energy-text-primary">{{currentRule.name}}</text>
          </view>
          <view class="detail-item">
            <text class="energy-text-tertiary">åˆ›å»ºæ—¶é—´ï¼š</text>
            <text class="energy-text-primary">{{currentRule.createTime}}</text>
          </view>
          <view class="detail-item">
            <text class="energy-text-tertiary">æ‰§è¡Œæ¬¡æ•°ï¼š</text>
            <text class="energy-text-primary">{{currentRule.executeCount}}æ¬¡</text>
          </view>
          <view class="detail-item">
            <text class="energy-text-tertiary">çŠ¶æ€ï¼š</text>
            <text class="{{currentRule.enabled ? 'energy-text-success' : 'energy-text-error'}}">{{currentRule.enabled ? 'å·²å¯ç”¨' : 'å·²ç¦ç”¨'}}</text>
          </view>
        </view>
        
        <!-- è§¦å‘æ¡ä»¶ -->
        <view class="detail-section">
          <text class="energy-title-small energy-mb-8">è§¦å‘æ¡ä»¶</text>
          <!-- å®šæ—¶è§¦å‘ -->
          <block wx:if="{{currentRule.trigger.type === 'time'}}">
            <view class="detail-item" wx:for="{{currentRule.trigger.conditions}}" wx:key="index">
              <text class="energy-text-tertiary">æ—¶é—´ï¼š</text>
              <text class="energy-text-primary">{{item.time}} ({{item.days.join(', ')}})</text>
            </view>
          </block>
          
          <!-- æ¡ä»¶è§¦å‘ -->
          <block wx:if="{{currentRule.trigger.type === 'condition'}}">
            <view class="detail-item" wx:for="{{currentRule.trigger.conditions}}" wx:key="index">
              <text class="energy-text-tertiary">æ¡ä»¶ï¼š</text>
              <text class="energy-text-primary">{{item.deviceId}} çš„ {{item.parameter}} {{item.operator}} {{item.value}}</text>
            </view>
          </block>
        </view>
        
        <!-- æ‰§è¡ŒåŠ¨ä½œ -->
        <view class="detail-section">
          <text class="energy-title-small energy-mb-8">æ‰§è¡ŒåŠ¨ä½œ</text>
          <view class="detail-item" wx:for="{{currentRule.actions}}" wx:key="index">
            <text class="energy-text-tertiary">åŠ¨ä½œ{{index+1}}ï¼š</text>
            <text class="energy-text-primary">{{item.deviceId}} {{item.action}}</text>
          </view>
        </view>
      </view>
      
      <view class="rule-detail-footer">
        <view class="energy-btn energy-btn-outline" bindtap="onEditRule" data-id="{{currentRule.id}}">
          <text>ç¼–è¾‘è§„åˆ™</text>
        </view>
        <view class="energy-btn energy-btn-primary" bindtap="onCloseDetail">
          <text>å…³é—­</text>
        </view>
      </view>
    </view>
  </view>
</view>